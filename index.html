<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EXOT - Exam Management System</title>
  <meta name="description" content="Sistem Manajemen Ujian EXOT untuk English, Arabic, dan Al-Quran">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">
          <span class="logo-icon">📝</span>
          EXOT
        </a>
        <nav class="nav" id="mainNav"></nav>
        <img src="img/logo-alwildan.png" alt="SD Alwildan 4" style="height: 40px; width: auto; margin-left: auto;">
      </div>
    </div>
  </header>


  <!-- Main Content -->
  <main class="container" style="padding: 2rem 1.5rem;">
    <!-- Hero Section -->
    <section class="fade-in" style="text-align: center; margin-bottom: 2rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">☁️ EXOT Exam System</h1>
      <p style="font-size: 1.1rem; color: var(--text-secondary);">
        Sistem manajemen ujian <strong>English</strong>, <strong>Arabic</strong>, dan <strong>Al-Quran</strong>
      </p>
    </section>

    <!-- Login Section (Not Logged In) -->
    <div id="loginSection" style="display: none;">
      <div class="card fade-in" style="max-width: 400px; margin: 0 auto;">
        <div class="card-header">
          <h3 class="card-title">🔐 Login</h3>
          <p class="card-subtitle">Masuk untuk mengakses sistem</p>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label class="form-label" for="username">Username</label>
            <input type="text" id="username" class="form-input" placeholder="Masukkan username" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="password">Password</label>
            <div style="position: relative;">
              <input type="password" id="password" class="form-input" placeholder="Masukkan password" required>
              <span id="togglePassword"
                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">👁️</span>
            </div>
          </div>
          <script>
            const togglePassword = document.querySelector('#togglePassword');
            const password = document.querySelector('#password');
            togglePassword.addEventListener('click', function (e) {
              const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
              password.setAttribute('type', type);
              this.textContent = type === 'password' ? '👁️' : '🙈';
            });
          </script>


          <div id="loginError" class="alert alert-error" style="display: none;">
            Username atau password salah!
          </div>

          <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
            Login
          </button>
        </form>

        <p style="text-align: center; margin-top: 1rem; color: var(--text-muted); font-size: 0.85rem;">
          Admin default: admin / exot2026
        </p>
      </div>
    </div>

    <!-- Logged In View -->
    <div id="loggedInSection" style="display: none;">
      <!-- User Info Card -->
      <div class="card fade-in" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
          <div>
            <h3 style="margin: 0;">Selamat datang, <span id="userName">User</span>!</h3>
            <p style="margin: 0.25rem 0 0; color: var(--text-muted);">
              <span class="role-badge" id="userRole">Role</span>
            </p>
          </div>
          <div id="examinerSubject" style="display: none;">
            <span class="badge badge-info" style="font-size: 1rem; padding: 0.5rem 1rem;">
              📚 Penguji <span id="subjectName">Mapel</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Panitia Utama Menu -->
      <div id="panitiaMenu" style="display: none;">
        <h3 style="margin-bottom: 1rem;">📋 Menu Panitia Utama</h3>
        <div class="grid grid-3">
          <div class="card subject-card" onclick="window.location.href='register.html'" style="cursor: pointer;">
            <h4>📝 Data & Registrasi</h4>
            <p>Input siswa, guru, kelas, dan penguji</p>
          </div>
          <div class="card subject-card" onclick="window.location.href='attendance.html'" style="cursor: pointer;">
            <h4>📷 Absensi QR</h4>
            <p>Scan QR code siswa</p>
          </div>
          <div class="card subject-card" onclick="window.location.href='scan-examiner.html'" style="cursor: pointer;">
            <h4>🎁 Scan Reward Penguji</h4>
            <p>Klaim souvenir penguji</p>
          </div>
        </div>

        <h3 style="margin: 2rem 0 1rem;">📊 Penilaian per Mapel</h3>
        <div class="grid grid-3">
          <div class="card subject-card english" onclick="window.location.href='exam-english.html'"
            style="cursor: pointer;">
            <h4>📖 English</h4>
            <p>Input nilai English</p>
          </div>
          <div class="card subject-card arabic" onclick="window.location.href='exam-arabic.html'"
            style="cursor: pointer;">
            <h4>📕 Arabic</h4>
            <p>Input nilai Arabic</p>
          </div>
          <div class="card subject-card alquran" onclick="window.location.href='exam-alquran.html'"
            style="cursor: pointer;">
            <h4>📗 Al-Quran</h4>
            <p>Input nilai Al-Quran</p>
          </div>
        </div>

        <div style="margin-top: 1.5rem;">
          <div class="card subject-card" onclick="window.location.href='dashboard.html'" style="cursor: pointer;">
            <h4>📈 Dashboard & Rekap</h4>
            <p>Lihat semua hasil ujian dan export data</p>
          </div>
        </div>
      </div>

      <!-- Penguji Menu -->
      <div id="pengujiMenu" style="display: none;">
        <h3 style="margin-bottom: 1rem;">📚 Menu Penguji</h3>
        <div class="grid grid-2">
          <div class="card subject-card" id="pengujiExamCard" style="cursor: pointer;">
            <h4>✏️ Input Nilai</h4>
            <p>Klik untuk mulai menilai siswa</p>
          </div>
          <div class="card subject-card" onclick="window.location.href='examiner-reward.html'" style="cursor: pointer;">
            <h4>🎁 Reward Saya</h4>
            <p>Lihat QR code reward setelah selesai</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Floating Login/Logout at Bottom Left -->
  <div class="floating-auth" id="floatingAuth">
    <button class="btn btn-secondary" id="floatingBtn" onclick="toggleAuth()">
      🔐 Login
    </button>
  </div>

  <!-- Settings Toggle -->
  <div class="settings-toggle no-print">
    <button class="btn btn-secondary" onclick="toggleDarkMode()" title="Dark Mode">🌙</button>
  </div>

  <!-- Password Change Modal -->
  <div id="passwordModal" class="modal-overlay" style="display: none;">
    <div class="card modal" style="max-width: 400px;">
      <h3 style="margin: 0 0 1rem;">🔐 Ganti Password</h3>
      <div class="form-group">
        <label class="form-label">Password Lama</label>
        <input type="password" id="oldPassword" class="form-input" placeholder="Password lama">
      </div>
      <div class="form-group">
        <label class="form-label">Password Baru</label>
        <input type="password" id="newPassword" class="form-input" placeholder="Password baru">
      </div>
      <div class="form-group">
        <label class="form-label">Konfirmasi Password</label>
        <input type="password" id="confirmPassword" class="form-input" placeholder="Ulangi password baru">
      </div>
      <div id="passwordError" class="alert alert-error" style="display: none;"></div>
      <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closePasswordModal()">Batal</button>
        <button class="btn btn-primary" onclick="submitPasswordChange()">Simpan</button>
      </div>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script>
    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => { });
      }

      updateUI();
    });

    function updateUI() {
      const session = getSession();
      const loginSection = document.getElementById('loginSection');
      const loggedInSection = document.getElementById('loggedInSection');
      const floatingBtn = document.getElementById('floatingBtn');
      const mainNav = document.getElementById('mainNav');

      if (session) {
        loginSection.style.display = 'none';
        loggedInSection.style.display = 'block';
        floatingBtn.innerHTML = '🚪 Logout';

        document.getElementById('userName').textContent = session.name;
        document.getElementById('userRole').textContent =
          session.role === 'panitia_utama' ? '👑 Panitia Utama' : '📚 Penguji';

        // Show appropriate menu
        if (session.role === 'panitia_utama') {
          document.getElementById('panitiaMenu').style.display = 'block';
          document.getElementById('pengujiMenu').style.display = 'none';
          document.getElementById('examinerSubject').style.display = 'none';

          mainNav.innerHTML = `
            <a href="register.html" class="nav-link">Data</a>
            <a href="attendance.html" class="nav-link">Absensi</a>
            <a href="exam-english.html" class="nav-link">English</a>
            <a href="exam-arabic.html" class="nav-link">Arabic</a>
            <a href="exam-alquran.html" class="nav-link">Al-Quran</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
          `;
        } else {
          document.getElementById('panitiaMenu').style.display = 'none';
          document.getElementById('pengujiMenu').style.display = 'block';
          document.getElementById('examinerSubject').style.display = 'block';

          const subjectNames = { english: 'English', arabic: 'Arabic', alquran: 'Al-Quran' };
          const subjectUrls = { english: 'exam-english.html', arabic: 'exam-arabic.html', alquran: 'exam-alquran.html' };

          document.getElementById('subjectName').textContent = subjectNames[session.subject] || session.subject;
          document.getElementById('pengujiExamCard').onclick = function () {
            window.location.href = subjectUrls[session.subject];
          };

          mainNav.innerHTML = `
            <a href="${subjectUrls[session.subject]}" class="nav-link">Input Nilai</a>
            <a href="examiner-reward.html" class="nav-link">Reward</a>
            <a href="#" class="nav-link" onclick="openPasswordModal()">🔐 Ganti Password</a>
          `;
        }

        // Check redirect
        const params = new URLSearchParams(window.location.search);
        const redirect = params.get('redirect');
        if (redirect && redirect !== 'index.html') {
          window.location.href = redirect;
        }
      } else {
        loginSection.style.display = 'block';
        loggedInSection.style.display = 'none';
        floatingBtn.innerHTML = '🔐 Login';
        mainNav.innerHTML = '';
      }
    }

    // Handle login
    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');

      const session = login(username, password);

      if (session) {
        errorDiv.style.display = 'none';
        updateUI();
      } else {
        errorDiv.style.display = 'flex';
      }
    });

    function toggleAuth() {
      if (isLoggedIn()) {
        if (confirm('Yakin ingin logout?')) {
          logout();
          updateUI();
        }
      } else {
        document.getElementById('username').focus();
      }
    }

    // Password change functions
    function openPasswordModal() {
      document.getElementById('passwordModal').style.display = 'flex';
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('passwordError').style.display = 'none';
    }

    function submitPasswordChange() {
      const oldPass = document.getElementById('oldPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('passwordError');

      if (!oldPass || !newPass || !confirmPass) {
        errorDiv.textContent = 'Semua field harus diisi!';
        errorDiv.style.display = 'flex';
        return;
      }

      if (newPass !== confirmPass) {
        errorDiv.textContent = 'Password baru tidak cocok!';
        errorDiv.style.display = 'flex';
        return;
      }

      const session = getSession();
      if (!session) {
        errorDiv.textContent = 'Session tidak valid!';
        errorDiv.style.display = 'flex';
        return;
      }

      const result = changePassword(session.userId, oldPass, newPass);
      if (result.success) {
        alert('Password berhasil diubah!');
        closePasswordModal();
      } else {
        errorDiv.textContent = result.error;
        errorDiv.style.display = 'flex';
      }
    }
  </script>
  <script type="module" src="js/firebase-config.js"></script>
</body>

</html>