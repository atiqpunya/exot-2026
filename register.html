<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data & Registrasi - EXOT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .bulk-textarea {
            min-height: 180px;
        }

        .class-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            margin: 0.25rem;
        }

        .class-tag button {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
        }

        .export-option {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .export-option:hover {
            border-color: var(--primary);
            background: var(--bg-glass);
        }

        .export-option h5 {
            margin: 0 0 0.25rem;
        }

        .export-option p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo"><span class="logo-icon">📝</span> EXOT</a>
                <nav class="nav">
                    <a href="register.html" class="nav-link active">Data</a>
                    <a href="attendance.html" class="nav-link">Absensi</a>
                    <a href="exam-english.html" class="nav-link">English</a>
                    <a href="exam-arabic.html" class="nav-link">Arabic</a>
                    <a href="exam-alquran.html" class="nav-link">Al-Quran</a>
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                </nav>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 12px; text-align: right;">
                    <span style="font-size: 0.7rem; color: #64748b; line-height: 1.2;">
                        Dibuat oleh<br>
                        <strong style="color: var(--primary);">Muhammad Atiq Qoidul Islam</strong>
                    </span>
                    <img src="img/logo-alwildan.png" alt="SD Alwildan 4" style="height: 40px; width: auto;">
                </div>
            </div>
        </div>
    </header>

    <div id="authRequired" class="container" style="padding: 3rem; display: none;">
        <div class="card" style="max-width: 400px; margin: 0 auto; text-align: center;">
            <h2>🔐 Login Diperlukan</h2>
            <p>Halaman ini hanya untuk Panitia Utama</p>
            <a href="index.html?redirect=register.html" class="btn btn-primary" style="margin-top: 1rem;">Login</a>
        </div>
    </div>

    <main id="mainContent" class="container" style="padding: 1.5rem; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="index.html" class="btn btn-secondary">🏠 Home</a>
                <h2 style="margin: 0; color: var(--text-primary);">Data Registrasi</h2>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="forceLoadCloud()" title="Ambil data dari Cloud">☁️
                    Load</button>
                <button class="btn btn-primary" onclick="forceSaveCloud()" title="Simpan data ke Firebase">💾
                    Save</button>
            </div>
        </div>
        <!-- Stats -->
        <div class="grid grid-4 fade-in" style="margin-bottom: 1.5rem;">
            <div class="card stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total Peserta</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="statSiswa">0</div>
                <div class="stat-label">Siswa</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="statPanitia">0</div>
                <div class="stat-label">Panitia</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="statPenguji">0</div>
                <div class="stat-label">Penguji</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card fade-in">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('siswa')" id="btnTabSiswa">👨‍🎓 Siswa</button>
                <button class="tab-btn" onclick="switchTab('panitia')" id="btnTabPanitia">👔 Panitia</button>
                <button class="tab-btn" onclick="switchTab('penguji')" id="btnTabPenguji">👨‍🏫 Penguji</button>
                <button class="tab-btn" onclick="switchTab('soal')" id="btnTabSoal">📝 Soal Ujian</button>
                <button class="tab-btn" onclick="switchTab('ruangan')" id="btnTabRuangan">🏫 Ruangan</button>
                <button class="tab-btn" onclick="switchTab('export')" id="btnTabExport">📦 Export</button>
            </div>

            <!-- Siswa Tab -->
            <div id="siswaTab" class="tab-content active">
                <h4 style="margin-bottom: 1rem;">📄 Bulk Input Siswa</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                    Format: <code>Nama, Ruangan</code>
                </p>
                <textarea id="bulkStudents" class="bulk-textarea" placeholder="Ahmad Fauzi, 7A
Siti Aminah, 7B
..."></textarea>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="importStudents()">📥 Import Siswa</button>
                    <button class="btn btn-danger" onclick="clearAllStudents()">🗑️ Hapus Semua</button>
                </div>
                <div id="studentImportResult" class="alert alert-success" style="display: none; margin-top: 1rem;">
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4>📋 Daftar Siswa (<span id="studentCount">0</span>)</h4>
                    <div style="display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap;">
                        <input type="text" id="searchStudent" class="form-input" placeholder="🔍 Cari Siswa..."
                            style="width: 100%;">
                    </div>
                    <div id="studentList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Panitia Tab -->
            <div id="panitiaTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">👔 Bulk Input Panitia</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                    Format: <code>Username, Password, Nama, Jabatan/Unit</code>
                </p>
                <textarea id="bulkPanitia" class="bulk-textarea" placeholder="panitia1, pass123, Budi Santoso, Ketua Panitia
sekretaris, securepass, Siti Rahma, Sekretaris
..."></textarea>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="importPanitia()">📥 Import Panitia</button>
                    <button class="btn btn-danger" onclick="clearAllPanitia()">🗑️ Hapus Semua</button>
                </div>
                <div id="panitiaImportResult" class="alert alert-success" style="display: none; margin-top: 1rem;">
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4>📋 Daftar Panitia (<span id="panitiaCount">0</span>)</h4>
                    <div style="display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap;">
                        <input type="text" id="searchPanitia" class="form-input" placeholder="🔍 Cari Panitia..."
                            style="width: 100%;">
                    </div>
                    <div id="panitiaList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Penguji Tab -->
            <div id="pengujiTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">👨‍🏫 Bulk Input Penguji</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                    Format: <code>Username, Password, Nama, Mapel, Ruangan (opsional)</code><br>
                    Mapel: english / arabic / alquran<br>
                    Ruangan bisa lebih dari satu, pisahkan dengan <code>|</code>
                </p>
                <textarea id="bulkExaminers" class="bulk-textarea" placeholder="eng1, pass123, Pak Ahmad, english, 7A|7B|7C
arb1, pass123, Bu Fatimah, arabic, 8A|8B|8C
qrn1, pass123, Ustadz Ali, alquran
..."></textarea>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="importExaminers()">📥 Import Penguji</button>
                </div>
                <div id="examinerImportResult" class="alert alert-success" style="display: none; margin-top: 1rem;">
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4>📋 Daftar Penguji (<span id="examinerCount">0</span>)</h4>
                    <div id="examinerList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Soal Tab -->
            <div id="soalTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">📝 Kelola Soal Ujian</h4>
                <div class="card" style="background: var(--bg-surface); padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h5 style="margin-top: 0;">➕ Tambah Soal Baru</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.5rem; display: block;">Mata
                                Pelajaran</label>
                            <select id="questionSubject" class="form-input form-select">
                                <option value="english">English</option>
                                <option value="arabic">Arabic</option>
                                <option value="alquran">Al-Quran</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.5rem; display: block;">Ruangan</label>
                            <select id="questionRoom" class="form-input form-select">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="font-size: 0.85rem; margin-bottom: 0.5rem; display: block;">Link File Soal (PDF /
                        Drive)</label>
                    <input type="text" id="questionContent" class="form-input"
                        placeholder="Paste link PDF atau Google Drive di sini..." required>
                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">Pastikan link bisa
                        diakses publik (Anyone with the link)</small>
                </div>
                <button class="btn btn-primary" onclick="submitQuestion()">💾 Simpan Soal</button>
            </div>

            <div style="margin-top: 2rem; border-top: 1px dashed var(--border-color); padding-top: 1rem;">
                <h4 style="margin-bottom: 1rem;">📋 Daftar Soal Tersimpan</h4>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <select id="filterQuestionRoom" class="form-input form-select" style="width: auto;"
                        onchange="loadQuestionList()">
                        <option value="all">Semua Ruangan</option>
                    </select>
                    <select id="filterQuestionSubject" class="form-input form-select" style="width: auto;"
                        onchange="loadQuestionList()">
                        <option value="all">Semua Mapel</option>
                        <option value="english">English</option>
                        <option value="arabic">Arabic</option>
                        <option value="alquran">Al-Quran</option>
                    </select>
                </div>
                <!-- Fixed height container for list -->
                <div id="questionList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Ruangan Tab -->
        <div id="ruanganTab" class="tab-content">
            <h4 style="margin-bottom: 1rem;">🏫 Kelola Ruangan</h4>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <input type="text" id="newClassName" class="form-input" placeholder="Nama ruangan baru..."
                    style="flex: 1;">
                <button class="btn btn-primary" onclick="addNewClass()">+ Tambah</button>
            </div>
            <div id="classList" style="margin-top: 1rem;"></div>

            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h4>✏️ Edit Nama Ruangan</h4>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                    <select id="editClassOld" class="form-input form-select" style="width: auto;"></select>
                    <span style="align-self: center;">→</span>
                    <input type="text" id="editClassNew" class="form-input" placeholder="Nama baru"
                        style="width: 150px;">
                    <button class="btn btn-secondary" onclick="editClass()">Simpan</button>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="exportTab" class="tab-content">
            <h4 style="margin-bottom: 1rem;">📦 Export & Backup</h4>

            <div class="grid grid-2" style="gap: 1.5rem;">
                <div>
                    <h5 style="margin-bottom: 0.75rem;">📄 Download QR sebagai HTML</h5>

                    <div class="export-option" onclick="exportQR('all')">
                        <h5>📦 Semua Data</h5>
                        <p>Download QR semua siswa, guru, dan penguji</p>
                    </div>

                    <div class="export-option" onclick="exportQR('siswa')">
                        <h5>👨‍🎓 Hanya Siswa</h5>
                        <p>Download QR code semua siswa saja</p>
                    </div>

                    <div class="export-option" onclick="exportQR('panitia')">
                        <h5>👔 Hanya Panitia</h5>
                        <p>Download QR code semua panitia saja</p>
                    </div>

                    <div class="export-option" onclick="exportQR('penguji')">
                        <h5>📋 Hanya Penguji</h5>
                        <p>Download QR code semua penguji saja</p>
                    </div>

                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <h5 style="margin-bottom: 0.75rem;">🖨️ Print QR Cards</h5>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                            <select id="printPaperSize" class="form-input form-select" style="width: auto;">
                                <option value="A4">A4 (210×297mm)</option>
                                <option value="A3">A3 (297×420mm)</option>
                            </select>
                            <select id="printCardCount" class="form-input form-select" style="width: auto;">
                                <option value="4">4 kartu/halaman (2×2)</option>
                                <option value="6">6 kartu/halaman (2×3)</option>
                                <option value="8">8 kartu/halaman (2×4)</option>
                                <option value="9">9 kartu/halaman (3×3)</option>
                            </select>
                        </div>
                        <div class="export-option" onclick="togglePrintSettings()">
                            <h5>🖨️ Cetak QR Cards</h5>
                            <p>Cetak kartu QR sesuai pengaturan</p>
                        </div>

                        <div id="printSettings"
                            style="display: none; background: var(--bg-surface); padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-top: 0.5rem;">
                            <h6 style="margin-bottom: 0.5rem;">Pengaturan Batch</h6>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.8rem;">Mulai dari</label>
                                    <input type="number" id="printStart" class="form-input" value="1" min="1">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.8rem;">Jumlah</label>
                                    <input type="number" id="printLimit" class="form-input" value="50" min="1">
                                </div>
                            </div>
                            <div style="margin-bottom: 0.5rem;">
                                <label class="form-control">
                                    <input type="checkbox" id="printHighQuality" checked>
                                    High Quality (HD)
                                </label>
                            </div>
                            <button class="btn btn-primary btn-sm" style="width: 100%;" onclick="printQRCards()">🖨️
                                Generate & Print</button>
                            <div id="printProgress"
                                style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); display: none;">
                                Siap...</div>
                        </div>
                    </div>
                </div>

                <div>
                    <div
                        style="background: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                        <h5 style="margin-bottom: 1rem; color: var(--text-primary);">🛠️ Data Center</h5>

                        <!-- Row 1: Quick Actions -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 1rem;">
                            <div class="export-option" onclick="exportToCSV()"
                                style="margin: 0; padding: 10px; text-align: center;">
                                <h6 style="margin: 0; font-size: 0.9rem;">📊 Full CSV</h6>
                                <small style="font-size: 0.75rem;">All Backup</small>
                            </div>
                            <div class="export-option" onclick="createBackup()"
                                style="margin: 0; padding: 10px; text-align: center;">
                                <h6 style="margin: 0; font-size: 0.9rem;">💾 Backup JSON</h6>
                                <small style="font-size: 0.75rem;">Save Data</small>
                            </div>
                        </div>

                        <!-- Row 2: Canva Export -->
                        <div
                            style="background: #fdf4ff; border: 1px solid #e879f9; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                            <h6 style="margin: 0 0 8px 0; color: #9333ea; font-size: 0.9rem;">🎨 Canva Export (Bulk)
                            </h6>
                            <div style="display: flex; gap: 15px; margin-bottom: 8px; flex-wrap: wrap;">
                                <label
                                    style="cursor: pointer; font-size: 0.8rem; display: flex; align-items: center;"><input
                                        type="checkbox" id="checkStudent" checked style="margin-right:4px;">
                                    Student</label>
                                <label
                                    style="cursor: pointer; font-size: 0.8rem; display: flex; align-items: center;"><input
                                        type="checkbox" id="checkExaminer" checked style="margin-right:4px;">
                                    Examiner</label>
                                <label
                                    style="cursor: pointer; font-size: 0.8rem; display: flex; align-items: center;"><input
                                        type="checkbox" id="checkCommittee" checked style="margin-right:4px;">
                                    Committee</label>
                            </div>
                            <button class="btn btn-sm" style="width: 100%; background: #9333ea; color: white;"
                                onclick="exportCanvaCSV()">⬇️ Download CSV</button>
                        </div>

                        <!-- Row 3: HTML QR Export -->
                        <div style="margin-bottom: 10px;">
                            <h6 style="margin-bottom: 5px; font-size: 0.9rem;">📄 Export QR (HTML)</h6>
                            <div style="display: flex; gap: 5px;">
                                <select id="exportHtmlCategory" class="form-input"
                                    style="padding: 6px; font-size: 0.85rem;">
                                    <option value="all">Semua Data</option>
                                    <option value="siswa">Hanya Siswa</option>
                                    <option value="panitia">Hanya Panitia</option>
                                    <option value="penguji">Hanya Penguji</option>
                                </select>
                                <button class="btn btn-primary btn-sm"
                                    onclick="exportQR(document.getElementById('exportHtmlCategory').value)">Go</button>
                            </div>
                        </div>

                        <!-- Restore Link -->
                        <div style="text-align: center; margin-top: 10px;">
                            <small style="cursor: pointer; text-decoration: underline; color: var(--primary);"
                                onclick="document.getElementById('restoreFile').click()">📥 Restore from Backup
                                File</small>
                        </div>
                    </div>
                    <p>Pulihkan data dari file backup</p>
                </div>
                <input type="file" id="restoreFile" accept=".json" style="display: none;"
                    onchange="handleRestore(event)">
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h5 style="margin-bottom: 0.75rem;">🔍 Download QR Individual</h5>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <input type="text" id="searchQR" class="form-input" placeholder="Cari nama..." style="flex: 1;">
                    <button class="btn btn-secondary" onclick="searchAndShowQR()">Cari</button>
                </div>
                <div id="individualQRResult" style="margin-top: 1rem;"></div>
            </div>
        </div>
        </div>
        </div>
        </div>
    </main>

    <div class="floating-auth">
        <button class="btn btn-secondary" onclick="toggleAuth()" id="floatingBtn">🔐 Login</button>
    </div>

    <script src="js/storage.js?v=2.6"></script>
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check auth
            const session = getSession();
            if (!session || (session.role !== 'panitia_utama' && session.role !== 'panitia' && session.role !== 'guru')) {
                window.location.href = 'index.html';
            }

            // Role-based UI restriction
            if (session.role !== 'panitia_utama') {
                // Hide restricted tabs for regular Panitia
                if (document.getElementById('btnTabPanitia')) document.getElementById('btnTabPanitia').style.display = 'none';
                if (document.getElementById('btnTabPenguji')) document.getElementById('btnTabPenguji').style.display = 'none';
            }

            // Show content and update button
            document.getElementById('mainContent').style.display = 'block';
            if (document.getElementById('floatingBtn')) document.getElementById('floatingBtn').innerHTML = '🚪 Logout';

            // Initial load
            updateStats();
            loadStudentList();
            if (session.role === 'panitia_utama') {
                loadPanitiaList(); // Only load if visible
                loadExaminerList();
            }

            // Listen for sync updates
            window.addEventListener('storage-update', () => {
                console.log('🔄 Data synced, refreshing UI...');
                updateStats();
                loadStudentList();
                loadExaminerList();
            });

            if (typeof loadClassList === 'function') loadClassList();

            // Initialize room dropdowns for questions
            loadQuestionRooms();

            document.getElementById('searchStudent').addEventListener('input', loadStudentList);
            document.getElementById('filterType').addEventListener('change', loadStudentList);
        });

        // ==========================================
        // QUESTION MANAGEMENT (SOAL UJIAN)
        // ==========================================

        function loadQuestionRooms() {
            const classes = getClasses();
            const qRoom = document.getElementById('questionRoom');
            const fRoom = document.getElementById('filterQuestionRoom');

            if (qRoom) {
                const current = qRoom.value;
                qRoom.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');
                if (current && classes.includes(current)) qRoom.value = current;
                else if (classes.length > 0) qRoom.value = classes[0];
            }
            if (fRoom) {
                const current = fRoom.value;
                fRoom.innerHTML = '<option value="all">Semua Ruangan</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
                fRoom.value = current;
            }
        }

        function submitQuestion() {
            const subject = document.getElementById('questionSubject').value;
            const room = document.getElementById('questionRoom').value;
            const content = document.getElementById('questionContent').value.trim();

            if (!content) return alert('Link soal tidak boleh kosong!');

            // Basic URL validation
            if (!content.startsWith('http')) {
                if (!confirm('Link sepertinya tidak valid (tidak diawali http/https). Tetap simpan?')) return;
            }

            addQuestion(room, subject, content); // Using storage.js function

            document.getElementById('questionContent').value = '';
            alert('✅ Link Soal berhasil disimpan!');
            loadQuestionList();
        }

        function removeQuestion(id) {
            if (confirm('Hapus soal ini?')) {
                deleteQuestion(id); // Using storage.js function
                loadQuestionList();
            }
        }

        function loadQuestionList() {
            const fRoom = document.getElementById('filterQuestionRoom').value;
            const fSubject = document.getElementById('filterQuestionSubject').value;

            let questions = getQuestions();

            if (fRoom !== 'all') questions = questions.filter(q => q.room === fRoom);
            if (fSubject !== 'all') questions = questions.filter(q => q.subject === fSubject);

            const container = document.getElementById('questionList');

            if (!questions.length) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Belum ada soal tersimpan</p>';
                return;
            }
            container.innerHTML = 'Wait...'; // placeholder

            // Group by room then subject
            const grouped = {};
            questions.forEach(q => {
                const key = `${q.room} - ${q.subject.toUpperCase()}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(q);
            });

            let html = '';
            for (const [group, items] of Object.entries(grouped)) {
                html += `
                    <div class="card" style="margin-bottom: 1rem; border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <h5 style="margin: 0;">${group}</h5>
                            <span class="badge badge-info">${items.length} Soal</span>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto; background: var(--bg-surface); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                            ${items.map(q => `
                                <div style="margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed var(--border-color);">
                                    <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                                        <a href="${q.content}" target="_blank" style="color: var(--primary); text-decoration: underline;">📄 Buka Link</a>
                                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${q.content}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <button class="btn btn-sm btn-danger" onclick="removeQuestion('${q.id}')" style="font-size: 0.7rem; padding: 2px 6px;">Hapus</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function toggleAuth() {
            if (isLoggedIn()) { logout(); window.location.href = 'index.html'; }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active',
                    (tab === 'siswa' && i === 0) ||
                    (tab === 'panitia' && i === 1) ||
                    (tab === 'penguji' && i === 2) ||
                    (tab === 'soal' && i === 3) ||
                    (tab === 'ruangan' && i === 4) ||
                    (tab === 'export' && i === 5)
                );
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'soal') {
                loadQuestionRooms();
                loadQuestionList();
            }
        }

        function updateStats() {
            const students = getStudents();
            const examiners = getExaminers();
            const panitia = getPanitia();
            document.getElementById('statTotal').textContent = students.length;
            document.getElementById('statSiswa').textContent = students.filter(s => s.type === 'siswa').length;
            document.getElementById('statPanitia').textContent = panitia.length;
            document.getElementById('statPenguji').textContent = examiners.length;
        }

        function importStudents() {
            const input = document.getElementById('bulkStudents').value.trim();
            if (!input) return alert('Masukkan data!');

            const lines = input.split('\n').filter(l => l.trim());
            let count = 0;

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts[0]) {
                    // Type is always siswa in this tab
                    addStudent(parts[0], parts[1] || '-', 'siswa');
                    count++;
                }
            });

            document.getElementById('bulkStudents').value = '';
            showResult('studentImportResult', `✅ ${count} siswa berhasil diimport!`);
            updateStats();
            loadStudentList();
        }

        function importPanitia() {
            const input = document.getElementById('bulkPanitia').value.trim();
            if (!input) return alert('Masukkan data!');

            const lines = input.split('\n').filter(l => l.trim());
            let count = 0, errors = [];

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 3) {
                    const username = parts[0];
                    const password = parts[1];
                    const name = parts[2];
                    const jabatan = parts[3] || 'Panitia';

                    // Use 'panitia' role. Store Jabatan in 'subject' property temporarily as it's unused for panitia
                    const result = addUser(username, password, name, 'panitia', jabatan);
                    if (result.error) errors.push(`${parts[0]}: ${result.error}`);
                    else count++;
                } else if (parts[0]) {
                    errors.push(`${parts[0]}: Format salah (Butuh: Username, Password, Nama)`);
                }
            });

            document.getElementById('bulkPanitia').value = '';
            let msg = `✅ ${count} panitia berhasil ditambahkan!`;
            if (errors.length) msg += `<br>⚠️ ${errors.join(', ')}`;
            showResult('panitiaImportResult', msg);
            updateStats();
            loadPanitiaList();
        }

        function clearAllPanitia() {
            if (confirm('⚠️ PERINGATAN: Apakah Anda yakin ingin menghapus SEMUA panitia?\n\nIni akan menghapus:\n1. Panitia dengan login (Baru)\n2. Panitia tanpa login (Lama)\n\nData tidak dapat dikembalikan!')) {
                // 1. Delete from Users (New System)
                const allUsers = getUsers();
                const panitiaUsers = allUsers.filter(u => u.role === 'panitia' && u.id !== 'admin-001');
                panitiaUsers.forEach(u => deleteUser(u.id));

                // 2. Delete from Students (Legacy System)
                const students = getStudents();
                const initialCount = students.length;
                const newStudents = students.filter(s => s.type !== 'panitia' && s.type !== 'guru');

                if (students.length !== newStudents.length) {
                    saveStudents(newStudents);
                }

                updateStats();
                loadPanitiaList();
                alert('✅ Data panitia berhasil dibersihkan.');
            }
        }

        function importExaminers() {
            const input = document.getElementById('bulkExaminers').value.trim();
            if (!input) return alert('Masukkan data!');

            const lines = input.split('\n').filter(l => l.trim());
            let count = 0, errors = [];

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 4) {
                    const classes = parts[4] ? parts[4].split('|').map(c => c.trim()) : [];
                    const result = addUser(parts[0], parts[1], parts[2], 'penguji', parts[3].toLowerCase(), classes);
                    if (result.error) errors.push(`${parts[0]}: ${result.error}`);
                    else count++;
                }
            });

            document.getElementById('bulkExaminers').value = '';
            let msg = `✅ ${count} penguji berhasil ditambahkan!`;
            if (errors.length) msg += `<br>⚠️ ${errors.join(', ')}`;
            showResult('examinerImportResult', msg);
            updateStats();
            loadExaminerList();
        }

        function showResult(id, msg) {
            const el = document.getElementById(id);
            el.innerHTML = msg;
            el.style.display = 'flex';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function loadStudentList() {
            let students = getStudents().filter(s => s.type === 'siswa');
            const search = document.getElementById('searchStudent').value.toLowerCase();

            if (search) students = students.filter(s => s.name.toLowerCase().includes(search) || s.class.toLowerCase().includes(search));

            document.getElementById('studentCount').textContent = students.length;
            const container = document.getElementById('studentList');

            if (!students.length) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Tidak ada data siswa</p>';
                return;
            }

            container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead><tr><th>No</th><th>Nama</th><th>Ruangan</th><th>Jenis</th><th>Aksi</th></tr></thead>
            <tbody>
              ${students.slice(0, 50).map((s, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${s.name}</td>
                  <td>${s.class}</td>
                  <td><span class="badge badge-success">Siswa</span></td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="downloadSingleQR('${s.id}', 'student')">📱</button>
                    <button class="btn btn-sm btn-danger" onclick="delStudent('${s.id}')">🗑️</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        ${students.length > 50 ? `<p style="text-align: center; color: var(--text-muted); margin-top: 0.5rem;">Menampilkan 50 dari ${students.length}</p>` : ''}
      `;
        }

        function getPanitia() {
            return getUsers().filter(u => u.role === 'panitia');
        }

        function loadPanitiaList() {
            let panitia = getPanitia();
            const search = document.getElementById('searchPanitia').value.toLowerCase();

            if (search) panitia = panitia.filter(s => s.name.toLowerCase().includes(search) || (s.subject && s.subject.toLowerCase().includes(search)));

            document.getElementById('panitiaCount').textContent = panitia.length;
            const container = document.getElementById('panitiaList');

            if (!panitia.length) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Tidak ada data panitia</p>';
                return;
            }

            container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead><tr><th>Username</th><th>Nama</th><th>Jabatan</th><th>Aksi</th></tr></thead>
            <tbody>
              ${panitia.slice(0, 50).map((s, i) => `
                <tr>
                  <td><strong>${s.username}</strong><br><small style="color:var(--text-muted)">${s.password}</small></td>
                  <td>${s.name}</td>
                  <td>${s.subject || '-'}</td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="downloadSingleQR('${s.id}', 'panitia')">📱</button>
                    <button class="btn btn-sm btn-danger" onclick="delPanitia('${s.id}')">🗑️</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
        }

        function delPanitia(id) {
            if (confirm('Hapus panitia ini?')) { deleteUser(id); updateStats(); loadPanitiaList(); }
        }

        function delStudent(id) {
            if (confirm('Hapus?')) { deleteStudent(id); updateStats(); loadStudentList(); }
        }

        async function clearAllStudents() {
            if (confirm('⚠️ PERINGATAN: Apakah Anda yakin ingin menghapus SEMUA data siswa?\nData yang dihapus tidak dapat dikembalikan!')) {
                const btn = document.querySelector('button[onclick="clearAllStudents()"]'); // Assuming there's a button calling this
                if (btn) {
                    btn.innerHTML = '⏳ Deleting...';
                    btn.disabled = true;
                }

                try {
                    // Update Local
                    saveStudents([]);

                    // Force Cloud Sync Immediately
                    alert('⏳ Sedang menghapus data dari server cloud (Google Sheets)...\nMohon tunggu hingga selesai.');

                    const result = await window.googleSheetsAPI.syncToCloud();

                    if (result && !result.error) {
                        alert('✅ Data berhasil dihapus permanen!');
                    } else {
                        throw new Error(result.error || 'Gagal sinkronisasi ke cloud');
                    }

                } catch (e) {
                    alert('⚠️ Data lokal terhapus, namun gagal menghapus di cloud: ' + e.message + '\nData mungkin kembali saat reload.');
                    console.error(e);
                } finally {
                    updateStats();
                    loadStudentList();
                    if (btn) {
                        btn.innerHTML = '🗑️ Hapus Semua';
                        btn.disabled = false;
                    }
                }
            }
        }

        function loadExaminerList() {
            const examiners = getExaminers();
            document.getElementById('examinerCount').textContent = examiners.length;
            const container = document.getElementById('examinerList');

            if (!examiners.length) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Belum ada penguji</p>';
                return;
            }

            const subjectColors = { english: 'info', arabic: 'success', alquran: 'warning' };
            const subjectNames = { english: 'English', arabic: 'Arabic', alquran: 'Al-Quran' };

            container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead><tr><th>Username</th><th>Nama</th><th>Mapel</th><th>Ruangan</th><th>Aksi</th></tr></thead>
            <tbody>
              ${examiners.map(e => `
                <tr>
                  <td><code>${e.username}</code></td>
                  <td>${e.name}</td>
                  <td><span class="badge badge-${subjectColors[e.subject]}">${subjectNames[e.subject]}</span></td>
                  <td>${e.assignedClasses?.join(', ') || 'Semua'}</td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="downloadSingleQR('${e.id}', 'examiner')">📱</button>
                    <button class="btn btn-sm btn-danger" onclick="delExaminer('${e.id}')">🗑️</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
        }

        function delExaminer(id) {
            if (confirm('Hapus penguji ini?')) { deleteUser(id); updateStats(); loadExaminerList(); }
        }

        function loadClassList() {
            const classes = getClasses();
            const container = document.getElementById('classList');
            const select = document.getElementById('editClassOld');

            container.innerHTML = classes.map(c => `
        <span class="class-tag">${c} <button onclick="delClass('${c}')">&times;</button></span>
      `).join('') || '<p style="color: var(--text-muted);">Belum ada ruangan</p>';

            select.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function addNewClass() {
            const name = document.getElementById('newClassName').value.trim();
            if (!name) return;
            addClass(name);
            document.getElementById('newClassName').value = '';
            loadClassList();
        }

        function delClass(name) {
            if (confirm(`Hapus ruangan ${name}?`)) { removeClass(name); loadClassList(); }
        }

        function editClass() {
            const oldName = document.getElementById('editClassOld').value;
            const newName = document.getElementById('editClassNew').value.trim();
            if (!oldName || !newName) return;
            updateClass(oldName, newName);
            document.getElementById('editClassNew').value = '';
            loadClassList();
            loadStudentList();
        }

        // Download single QR
        function downloadSingleQR(id, type) {
            let data, name, room, label;

            if (type === 'student') {
                const s = getStudentById(id);
                if (!s) return;
                data = s.qrCode || s.id;
                name = s.name;
                room = s.class;
                label = s.type || 'siswa';
            } else {
                const e = getUserById(id);
                if (!e) return;
                data = e.qrCode || e.id;
                name = e.name;
                // For panitia, subject is Jabatan
                room = e.subject || (e.role === 'panitia' ? 'Panitia' : '-');
                label = e.role === 'panitia' ? 'panitia' : 'penguji';
            }

            const qrCode = new QRCodeStyling({
                width: 300,
                height: 300,
                type: "png",
                data: data,
                // image: "img/logo-alwildan.png", // REMOVED
                dotsOptions: {
                    color: "#000",
                    type: "rounded"
                },
                backgroundOptions: {
                    color: "#fff",
                },
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 0
                }
            });

            qrCode.download({ name: `QR_${name.replace(/\s+/g, '_')}_${room}`, extension: "png" });
        }

        // Search and show individual QR
        function searchAndShowQR() {
            const search = document.getElementById('searchQR').value.toLowerCase().trim();
            if (!search) return;

            const students = getStudents().filter(s => s.name.toLowerCase().includes(search));
            // Search all users (examiners and panitia)
            const users = getUsers().filter(u => u.name.toLowerCase().includes(search) && (u.role === 'penguji' || u.role === 'panitia'));

            const container = document.getElementById('individualQRResult');
            const all = [...students.map(s => ({ ...s, isStudent: true })), ...users.map(e => ({ ...e, isUser: true }))];

            if (!all.length) {
                container.innerHTML = '<p style="color: var(--text-muted);">Tidak ditemukan</p>';
                return;
            }

            container.innerHTML = all.slice(0, 5).map(item => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
          <div>
            <strong>${item.name}</strong>
            <span class="badge badge-${item.isStudent ? 'success' : 'info'}" style="margin-left: 0.5rem;">
              ${item.isStudent ? (item.type || 'siswa') : (item.role || 'User')}
            </span>
          </div>
          <button class="btn btn-sm btn-primary" onclick="downloadSingleQR('${item.id}', '${item.isStudent ? 'student' : (item.role === 'panitia' ? 'panitia' : 'examiner')}')">📥 Download</button>
        </div>
      `).join('');
        }

        // Force Cloud Operations
        // Force Cloud Operations
        async function forceSaveCloud() {
            const btn = document.querySelector('button[title="Simpan data ke Firebase"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Saving...';
            btn.disabled = true;

            try {
                // Check if Firebase is ready
                if (!window.firebaseService) {
                    throw new Error("Firebase belum siap atau gagal dimuat.\nPeriksa koneksi internet Anda dan coba refresh halaman.");
                }

                // Use Firebase Upload
                const result = await window.firebaseService.uploadLocalData();
                if (result.success) {
                    alert('✅ Data berhasil disimpan ke Firebase!');
                } else {
                    throw new Error('Gagal upload:\n' + result.errors.join('\n'));
                }
            } catch (e) {
                alert('❌ Gagal menyimpan: ' + e.message);
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function forceLoadCloud() {
            if (!confirm('Ini akan menimpa data lokal dengan data dari Cloud. Lanjutkan?')) return;

            const btn = document.querySelector('button[title="Ambil data dari Cloud"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Loading...';
            btn.disabled = true;

            try {
                // Use Firebase Manual Pull
                const success = await window.firebaseService.syncFromCloud();
                if (success) {
                    alert('✅ Data berhasil diambil dari Firebase!');
                    location.reload(); // Refresh to show new data
                } else {
                    throw new Error('Gagal mengambil data');
                }
            } catch (e) {
                alert('❌ Error: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Export QR by category
        function exportQR(category) {
            let items = [];
            let title = '';

            if (category === 'all') {
                const students = getStudents();
                const examiners = getExaminers();
                const panitia = getPanitia();
                items = [
                    ...students.map(s => ({ name: s.name, room: s.class, type: s.type || 'siswa', qr: s.qrCode })),
                    ...panitia.map(p => ({ name: p.name, room: p.subject || 'Panitia', type: 'panitia', qr: p.id })),
                    ...examiners.map(e => ({ name: e.name, room: e.subject, type: 'penguji', qr: e.id }))
                ];
                title = 'Semua Data';
            } else if (category === 'siswa') {
                items = getStudents().filter(s => s.type !== 'guru').map(s => ({ name: s.name, room: s.class, type: 'siswa', qr: s.qrCode }));
                title = 'Siswa';
            } else if (category === 'panitia') {
                items = getPanitia().map(s => ({ name: s.name, room: s.subject || 'Panitia', type: 'panitia', qr: s.id }));
                title = 'Panitia';
            } else if (category === 'penguji') {
                items = getExaminers().map(e => ({ name: e.name, room: e.subject, type: 'penguji', qr: e.id }));
                title = 'Penguji';
            }

            if (!items.length) {
                alert('Tidak ada data untuk kategori ini!');
                return;
            }

            // Implement Batching Prompt
            const total = items.length;
            const range = prompt(`Total data: ${total}.\nMasukkan rentang yang ingin digenerate (contoh: 1-50):`, `1-${total > 50 ? 50 : total}`);

            if (!range) return; // Users cancelled

            const match = range.match(/^(\d+)-(\d+)$/);
            if (!match) {
                alert('Format salah! Gunakan format angka-angka (contoh: 1-50)');
                return;
            }

            const start = parseInt(match[1]);
            const end = parseInt(match[2]);

            if (start < 1 || end < start || start > total) {
                alert(`Rentang tidak valid! Harus antara 1 sampai ${total}.`);
                return;
            }

            // Slice items (convert 1-based index to 0-based)
            const slicedItems = items.slice(start - 1, end);

            // Warn if too many
            if (slicedItems.length > 100 && !confirm(`Anda akan generate ${slicedItems.length} QR code sekaligus. Ini mungkin membuat browser berat/hang. Lanjutkan?`)) {
                return;
            }

            // Convert items to JSON for the template
            const itemsJson = JSON.stringify(slicedItems);

            const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>EXOT QR - ${title} (${start}-${end})</title>
<script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"><\/script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #0ea5e9;
        }

        .info {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            page-break-inside: avoid;
        }

        .qr-container {
            width: 130px;
            height: 130px;
            margin: 0 auto 8px auto;
        }

        .card h3 {
            font-size: 12px;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .card p {
            font-size: 11px;
            color: #666;
        }

        .card .type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-top: 5px;
        }

        .card .code {
            display: block;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 8px 0;
            font-family: monospace;
            color: #333;
        }

        .card .meta {
            font-size: 10px;
            color: #666;
            margin-bottom: 5px;
        }

        .siswa {
            background: #dcfce7;
            color: #166534;
        }

        .guru {
            background: #dbeafe;
            color: #1e40af;
        }

        .penguji {
            background: #fef3c7;
            color: #92400e;
        }

        .download-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            font-size: 11px;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }

        .download-btn:hover {
            background: #0284c7;
        }

        @media print {
            body {
                padding: 0;
                background: white;
            }

            .card {
                border: 1px solid #000;
            }

            .download-btn {
                display: none;
            }
        }
    </style>
    </head>

    <body>
        <h1>📝 EXOT QR Codes - ${title} (${start}-${end})</h1>
        <p class="info">Total: ${slicedItems.length} (from ${total}) | Generated: ${new Date().toLocaleString('id-ID')}</p>
        <div class="grid" id="grid"></div>

        <script>
const items = ${itemsJson};
const grid = document.getElementById('grid');

items.forEach((item, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    
    card.innerHTML = \`
        <h3 style="font-size:14px; margin-bottom:8px;">\${item.name.toUpperCase()}</h3>
        <div id="qr-\${index}" class="qr-container"></div>
        <div class="code">\${item.qr.split('').join(' ')}</div>
        <div class="meta">\${item.room} <span class="type \${item.type}">\${item.type}</span></div>
        <button class="download-btn" onclick="downloadSingle('\${item.qr}', '\${item.name}', '\${item.room}')">📥 Download PNG</button>
    \`;
    grid.appendChild(card);

    // Generate QR
    const qrCode = new QRCodeStyling({
        width: 130,
        height: 130,
        type: "svg",
        data: item.qr,
        // image: "img/logo-alwildan.png", // REMOVED
        dotsOptions: { color: "#000", type: "rounded" },
        backgroundOptions: { color: "#fff" },
        imageOptions: { crossOrigin: "anonymous", margin: 0 }
    });
    qrCode.append(document.getElementById('qr-' + index));
});

function downloadSingle(data, name, room) {
    const qrCode = new QRCodeStyling({
        width: 300,
        height: 300,
        type: "png",
        data: data,
        // image: "img/logo-alwildan.png", // REMOVED
        dotsOptions: { color: "#000", type: "rounded" },
        backgroundOptions: { color: "#fff" },
        imageOptions: { crossOrigin: "anonymous", margin: 0 }
    });
    qrCode.download({ name: \`QR_\${name.replace(/\\s+/g, '_')}_\${room}\`, extension: "png" });
}
<\/script>
    </body>

</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `EXOT_QR_${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Handle restore from backup
        function handleRestore(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                if (confirm('Ini akan mengganti semua data yang ada. Lanjutkan?')) {
                    const result = restoreBackup(e.target.result);
                    if (result.error) {
                        alert('Error: ' + result.error);
                    } else {
                        alert('Data berhasil dipulihkan dari backup ' + result.date);
                        location.reload();
                    }
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function togglePrintSettings() {
            const el = document.getElementById('printSettings');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // Print QR cards with paper size, card count options, and custom Logos
        async function printQRCards() {
            const students = getStudents();
            if (!students.length) {
                alert('Tidak ada data siswa!');
                return;
            }

            const startIdx = parseInt(document.getElementById('printStart').value) - 1;
            const limit = parseInt(document.getElementById('printLimit').value);
            const isHD = document.getElementById('printHighQuality').checked;

            if (startIdx < 0 || startIdx >= students.length) {
                alert('Indeks mulai tidak valid!');
                return;
            }

            const targetStudents = students.slice(startIdx, startIdx + limit);
            if (!targetStudents.length) {
                alert('Tidak ada siswa dalam rentang ini!');
                return;
            }

            const btn = document.querySelector('#printSettings button');
            const progressEl = document.getElementById('printProgress');

            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Generating...';
            btn.disabled = true;
            progressEl.style.display = 'block';

            const paperSize = document.getElementById('printPaperSize').value;
            const cardCount = parseInt(document.getElementById('printCardCount').value);

            // Paper dimensions in mm
            const paperDims = {
                'A4': { width: 210, height: 297 },
                'A3': { width: 297, height: 420 }
            };

            // Grid layouts based on card count
            const gridLayouts = {
                4: { cols: 2, rows: 2 },
                6: { cols: 2, rows: 3 },
                8: { cols: 2, rows: 4 },
                9: { cols: 3, rows: 3 }
            };

            const paper = paperDims[paperSize];
            const grid = gridLayouts[cardCount];

            // QR size scales with card count but High Res for printing
            // If HD, generate at 1000px, otherwise 300px
            const qrGenSize = isHD ? 1000 : 300;

            // Display size in CSS (visual size on paper)
            const displaySize = cardCount <= 4 ? 120 : (cardCount <= 6 ? 100 : 85);
            const fontSize = cardCount <= 4 ? 14 : (cardCount <= 6 ? 12 : 11);

            // Helper to generate QR Data URI
            const generateQRDataUri = (data) => {
                return new Promise((resolve, reject) => {
                    const qrCode = new QRCodeStyling({
                        width: qrGenSize,
                        height: qrGenSize,
                        type: "png", // PNG is better for compatibility than SVG in blob url for print
                        data: data,
                        // image: "img/logo-alwildan.png", // REMOVED
                        dotsOptions: { color: "#000", type: "rounded" },
                        backgroundOptions: { color: "#fff" },
                        imageOptions: { crossOrigin: "anonymous", margin: isHD ? 20 : 0 }
                    });

                    qrCode.getRawData('png').then(blob => {
                        resolve(URL.createObjectURL(blob));
                    }).catch(reject);
                });
            };

            try {
                // Batch generation with delay to keep UI responsive
                const studentQRs = [];
                for (let i = 0; i < targetStudents.length; i++) {
                    const s = targetStudents[i];
                    progressEl.textContent = `Generating ${i + 1}/${targetStudents.length}: ${s.name}`;

                    const url = await generateQRDataUri(s.qrCode || s.id);
                    studentQRs.push({ ...s, qrUrl: url });

                    // Small delay every 5 items to breathe
                    if (i % 5 === 0) await new Promise(r => setTimeout(r, 10));
                }

                progressEl.textContent = 'Membuka jendela cetak...';

                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('Pop-up blocked! Izinkan pop-up untuk mencetak.');
                    return;
                }

                printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Print QR Cards - EXOT (${paperSize})</title>
        <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; }
            
            .page {
                width: ${paper.width}mm;
                min-height: ${paper.height}mm;
                padding: 10mm;
                display: grid;
                grid-template-columns: repeat(${grid.cols}, 1fr);
                grid-template-rows: repeat(${grid.rows}, 1fr);
                gap: 8mm;
                page-break-after: always;
            }
            .page:last-child { page-break-after: auto; }

            .card {
                border: 2px solid #0f172a;
                border-radius: 12px;
                padding: 10px;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }
            
            /* Background decoration */
            .card::before {
                content: '';
                position: absolute;
                top: 0; left: 0; right: 0; height: 6px;
                background: linear-gradient(90deg, #0ea5e9, #6366f1);
            }

            .card img {
                width: ${displaySize}px;
                height: ${displaySize}px;
                margin-bottom: 8px;
                /* Crisp rendering for QR */
                image-rendering: -webkit-optimize-contrast;
            }

            .card h3 {
                font-size: ${fontSize + 4}px;
                margin-bottom: 8px;
                word-break: break-word;
                line-height: 1.2;
                color: #000;
                font-weight: 800;
                text-transform: uppercase;
                max-width: 100%;
            }

            .card p {
                font-size: ${fontSize - 2}px;
                color: #64748b;
                font-weight: 500;
            }

            .card .type {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: ${fontSize - 4}px;
                margin-left: 5px;
                border: 1px solid #ccc;
                color: #444;
                font-weight: 600;
                text-transform: uppercase;
            }

            .card .code {
                font-size: 20px;
                margin: 5px 0 0 0;
                font-family: monospace;
                font-weight: 800;
                color: #000;
                letter-spacing: 4px;
            }

            @media print {
                @page { size: ${paperSize}; margin: 0; }
                body { margin: 0; }
            }
        </style>
    </head>
    <body>
        ${(() => {
                        let html = '';
                        for (let i = 0; i < studentQRs.length; i += cardCount) {
                            const pageItems = studentQRs.slice(i, i + cardCount);
                            html += '<div class="page">';
                            pageItems.forEach(s => {
                                const code = (s.qrCode || s.id).split('').join(' ');
                                html += '<div class="card">' +
                                    '<h3>' + s.name + '</h3>' +
                                    '<img src="' + s.qrUrl + '" alt="QR">' +
                                    '<div class="code">' + code + '</div>' +
                                    '<p>' + s.class + '<span class="type">' + (s.type || 'siswa') + '</span></p>' +
                                    '</div>';
                            });
                            html += '</div>';
                        }
                        return html;
                    })()}
    </body >
    </html >
    `);
                printWindow.document.close();

                // Allow images to load
                printWindow.onload = function () {
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                        // printWindow.close(); // Optional: close after print
                    }, 1000);
                };

            } catch (e) {
                console.error(e);
                alert('Gagal generate QR: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                progressEl.textContent = 'Selesai!';
                setTimeout(() => progressEl.style.display = 'none', 3000);
            }
        }
    </script>
    <!-- Footer Credit -->


    <footer style="text-align: center; margin-top: 2rem; color: var(--text-muted); font-size: 0.8rem;">
        <p>&copy; 2026 EXOT System. Created by Muhammad Atiq Qoidul Islam</p>
        <p>Version 2.4 (Local SDK)</p>
    </footer>

    <!-- Firebase Compat SDK (Local) -->
    <script src="js/firebase-app-compat.js"></script>
    <script src="js/firebase-firestore-compat.js"></script

    <!-- App Scripts (Compat Mode) -->
    <script src="js/firebase-config.js?v=2.5"></script>
    <script src="js/firebase-service.js?v=2.5"></script>
</body>

</html>