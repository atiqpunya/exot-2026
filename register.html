<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data & Registrasi - EXOT</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .bulk-textarea {
            min-height: 180px;
        }

        .class-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            margin: 0.25rem;
        }

        .class-tag button {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
        }

        .export-option {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .export-option:hover {
            border-color: var(--primary);
            background: var(--bg-glass);
        }

        .export-option h5 {
            margin: 0 0 0.25rem;
        }

        .export-option p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
    </style>
    <script>
        // Global variable to track which subject is being uploaded to via button
        console.log('Bulk Upload Script Loading from HEAD...');
        var currentUploadSubject = '';

        window.triggerFileUpload = function (subject) {
            console.log('Triggering upload for subject:', subject);
            currentUploadSubject = subject;

            const fileInput = document.getElementById('bulkFileInput');
            if (fileInput) {
                console.log('File input found, executing click()...');
                try {
                    fileInput.value = ''; // Reset value to allow selecting the same file again
                    fileInput.click();
                } catch (e) {
                    console.error('Error triggering click:', e);
                    alert('Gagal membuka file picker: ' + e.message);
                }
            } else {
                console.error('FATAL: Input element #bulkFileInput not found in DOM!');
                alert('Error sistem: Komponen upload tidak ditemukan. Mohon refresh halaman.');
            }
        };

        window.handleDragOver = function (e, el) {
            e.preventDefault();
            e.stopPropagation();
            el.style.transform = 'scale(1.02)';
            el.style.borderColor = getComputedStyle(el).color;
            el.style.backgroundColor = '#fff';
        };

        window.handleDragLeave = function (e, el) {
            e.preventDefault();
            e.stopPropagation();
            el.style.transform = 'scale(1)';
            // Reset to original colors based on data-subject
            const subject = el.getAttribute('data-subject');
            if (subject === 'english') {
                el.style.borderColor = '#3b82f6';
                el.style.backgroundColor = '#eff6ff';
            } else if (subject === 'arabic') {
                el.style.borderColor = '#10b981';
                el.style.backgroundColor = '#ecfdf5';
            } else if (subject === 'alquran') {
                el.style.borderColor = '#f59e0b';
                el.style.backgroundColor = '#fffbeb';
            }
        };

        window.handleDrop = function (e, subject) {
            e.preventDefault();
            e.stopPropagation();
            const el = e.currentTarget;
            handleDragLeave(e, el); // Reset style

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                console.log('Files dropped:', files.length);
                if (typeof processFiles === 'function') {
                    processFiles(files, subject);
                } else {
                    alert('Sistem belum siap sepenuhnya. Mohon tunggu sebentar...');
                }
            }
        };

        // For hidden file input
        window.handleSelectedFiles = function (files) {
            console.log('File selection detected:', files.length, 'files');
            if (files.length > 0 && currentUploadSubject) {
                if (typeof processFiles === 'function') {
                    processFiles(files, currentUploadSubject);
                } else {
                    alert('Sistem belum siap sepenuhnya. Mohon tunggu sebentar...');
                }
                // Reset for next use
                document.getElementById('bulkFileInput').value = '';
            } else if (files.length > 0) {
                console.error('Subject is missing for upload!');
                alert('Error: Subject not selected. Please try again.');
            }
        };
    </script>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo"><span class="logo-icon">📝</span> EXOT</a>
                <nav class="nav">
                    <a href="register.html" class="nav-link active">Data</a>
                    <a href="attendance.html" class="nav-link">Absensi</a>
                    <a href="exam-english.html" class="nav-link">English</a>
                    <a href="exam-arabic.html" class="nav-link">Arabic</a>
                    <a href="exam-alquran.html" class="nav-link">Al-Quran</a>
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                </nav>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 12px; text-align: right;">
                    <span style="font-size: 0.7rem; color: #64748b; line-height: 1.2;">
                        Dibuat oleh<br>
                        <strong style="color: var(--primary);">Muhammad Atiq Qoidul Islam</strong>
                    </span>
                    <img src="img/logo-alwildan.png" alt="SD Alwildan 4" style="height: 40px; width: auto;">
                </div>
            </div>
        </div>
    </header>

    <div id="authRequired" class="container" style="padding: 3rem; display: none;">
        <div class="card" style="max-width: 400px; margin: 0 auto; text-align: center;">
            <h2>🔐 Login Diperlukan</h2>
            <p>Halaman ini hanya untuk Panitia Utama</p>
            <a href="index.html?redirect=register.html" class="btn btn-primary" style="margin-top: 1rem;">Login</a>
        </div>
    </div>

    <main id="mainContent" class="container" style="padding: 1.5rem; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="index.html" class="btn btn-secondary">🏠 Home</a>
                <h2 style="margin: 0; color: var(--text-primary);">Data Registrasi</h2>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="forceLoadCloud()" title="Ambil data dari Cloud">☁️
                    Load</button>
                <button class="btn btn-primary" onclick="forceSaveCloud()" title="Simpan data ke Firebase">💾
                    Save</button>
            </div>
        </div>
        <!-- Stats -->
        <div class="grid grid-4 fade-in" style="margin-bottom: 1.5rem;">
            <div class="card stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">Total Peserta</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="statSiswa">0</div>
                <div class="stat-label">Siswa</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="statPanitia">0</div>
                <div class="stat-label">Panitia</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="statPenguji">0</div>
                <div class="stat-label">Penguji</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card fade-in">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('siswa')" id="btnTabSiswa">👨‍🎓 Siswa</button>
                <button class="tab-btn" onclick="switchTab('panitia')" id="btnTabPanitia">👔 Panitia</button>
                <button class="tab-btn" onclick="switchTab('penguji')" id="btnTabPenguji">👨‍🏫 Penguji</button>
                <button class="tab-btn" onclick="switchTab('soal')" id="btnTabSoal">📝 Soal Ujian</button>
                <button class="tab-btn" onclick="switchTab('ruangan')" id="btnTabRuangan">🏫 Ruangan</button>
                <button class="tab-btn" onclick="switchTab('export')" id="btnTabExport">📦 Export</button>
            </div>

            <!-- Siswa Tab -->
            <div id="siswaTab" class="tab-content active">
                <h4 style="margin-bottom: 1rem;">📄 Bulk Input Siswa</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                    Format: <code>Nama, Ruangan</code>
                </p>
                <textarea id="bulkStudents" class="bulk-textarea" placeholder="Ahmad Fauzi, 7A
Siti Aminah, 7B
..."></textarea>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="importStudents()">📥 Import Siswa</button>
                    <button class="btn btn-warning" onclick="deleteSelectedStudents()">🗑️ Hapus Terpilih</button>
                    <button class="btn btn-danger" onclick="clearAllStudents()">🗑️ Hapus Semua</button>
                </div>
                <div id="studentImportResult" class="alert alert-success" style="display: none; margin-top: 1rem;">
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4>📋 Daftar Siswa (<span id="studentCount">0</span>)</h4>
                    <div style="display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap;">
                        <input type="text" id="searchStudent" class="form-input" placeholder="🔍 Cari Siswa..."
                            style="width: 100%;">
                    </div>
                    <div id="studentList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Panitia Tab -->
            <div id="panitiaTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">👔 Bulk Input Panitia</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                    Format: <code>Username, Password, Nama, Jabatan/Unit</code>
                </p>
                <textarea id="bulkPanitia" class="bulk-textarea" placeholder="panitia1, pass123, Budi Santoso, Ketua Panitia
sekretaris, securepass, Siti Rahma, Sekretaris
..."></textarea>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadFromStorage()">☁️ Load</button>
                    <button class="btn btn-warning" onclick="manualSync()" id="btnSync">🔄 Sync Cloud</button>
                    <button class="btn btn-primary" onclick="saveDataManual()">💾 Save</button>
                </div>
                <div id="panitiaImportResult" class="alert alert-success" style="display: none; margin-top: 1rem;">
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4>📋 Daftar Panitia (<span id="panitiaCount">0</span>)</h4>
                    <div style="display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap;">
                        <input type="text" id="searchPanitia" class="form-input" placeholder="🔍 Cari Panitia..."
                            style="width: 100%;">
                    </div>
                    <div id="panitiaList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Penguji Tab -->
            <div id="pengujiTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">👨‍🏫 Bulk Input Penguji</h4>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                    Format: <code>Username, Password, Nama, Mapel, Ruangan (opsional)</code><br>
                    Mapel: english / arabic / alquran<br>
                    Ruangan bisa lebih dari satu, pisahkan dengan <code>|</code>
                </p>
                <textarea id="bulkExaminers" class="bulk-textarea" placeholder="eng1, pass123, Pak Ahmad, english, 7A|7B|7C
arb1, pass123, Bu Fatimah, arabic, 8A|8B|8C
qrn1, pass123, Ustadz Ali, alquran
..."></textarea>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="importExaminers()">📥 Import Penguji</button>
                </div>
                <div id="examinerImportResult" class="alert alert-success" style="display: none; margin-top: 1rem;">
                </div>

                <div style="margin-top: 1.5rem;">
                    <h4>📋 Daftar Penguji (<span id="examinerCount">0</span>)</h4>
                    <div id="examinerList" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Soal Tab -->
            <div id="soalTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">📝 Kelola Soal Ujian</h4>
                <div class="card" style="background: var(--bg-surface); padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h5 style="margin-top: 0;">➕ Tambah Soal Baru</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.5rem; display: block;">Mata
                                Pelajaran</label>
                            <select id="questionSubject" class="form-input form-select">
                                <option value="english">English</option>
                                <option value="arabic">Arabic</option>
                                <option value="alquran">Al-Quran</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.5rem; display: block;">Ruangan</label>
                            <select id="questionRoom" class="form-input form-select">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Bulk Upload Section (Subject Separation) -->
                <div style="margin-bottom: 2rem;">
                    <h5 style="margin-top: 0; margin-bottom: 0.5rem;">📤 Bulk Upload PDF (Per Mapel)</h5>
                    <div
                        style="background: #fff3cd; color: #856404; padding: 0.5rem 1rem; border-radius: 4px; margin-bottom: 1rem; border: 1px solid #ffeeba; font-size: 0.9rem;">
                        ⚠️ <strong>PENTING:</strong> Maksimal ukuran file adalah <strong>5 MB</strong>. Pastikan file
                        tidak rusak.
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem;">
                        Drag & Drop file PDF ke kotak mapel yang sesuai. Sistem akan otomatis menargetkan siswa.<br>
                        <strong>Format Nama File:</strong> <code>RUANGAN-NAMA SISWA.pdf</code><br>
                        Contoh: <code>7A-AHMAD FAUZI.pdf</code> (Subject ditentukan oleh kotak tempat Anda drop file)
                    </p>

                    <div class="grid grid-3" style="gap: 1rem;">
                        <!-- English Zone -->
                        <div class="card upload-card" data-subject="english"
                            style="border: 2px dashed #3b82f6; background: #eff6ff; text-align: center; cursor: pointer; transition: all 0.2s; position: relative;"
                            ondragenter="handleDragOver(event, this)" ondragover="handleDragOver(event, this)"
                            ondragleave="handleDragLeave(event, this)" ondrop="handleDrop(event, 'english')"
                            onclick="triggerFileUpload('english')">
                            <!-- Helper overlay to catch events -->
                            <div style="pointer-events: none;">
                                <img src="https://flagcdn.com/w80/gb.png" alt="UK Flag"
                                    style="height: 48px; margin-bottom: 0.5rem; display: block; margin: 0 auto 0.5rem auto;">
                                <h6 style="color: #1e40af; margin: 0;">ENGLISH</h6>
                                <p style="font-size: 0.75rem; color: #1e3a8a;">Drop PDF or Click to Browse<br><span
                                        style="font-size:0.7rem; opacity:0.8">(Local / Drive • Max 5MB)</span></p>
                            </div>
                        </div>

                        <!-- Arabic Zone -->
                        <div class="card upload-card" data-subject="arabic"
                            style="border: 2px dashed #10b981; background: #ecfdf5; text-align: center; cursor: pointer; transition: all 0.2s; position: relative;"
                            ondragenter="handleDragOver(event, this)" ondragover="handleDragOver(event, this)"
                            ondragleave="handleDragLeave(event, this)" ondrop="handleDrop(event, 'arabic')"
                            onclick="triggerFileUpload('arabic')">
                            <div style="pointer-events: none;">
                                <img src="https://flagcdn.com/w80/sa.png" alt="Saudi Flag"
                                    style="height: 48px; margin-bottom: 0.5rem; display: block; margin: 0 auto 0.5rem auto;">
                                <h6 style="color: #065f46; margin: 0;">ARABIC</h6>
                                <p style="font-size: 0.75rem; color: #064e3b;">Drop PDF or Click to Browse<br><span
                                        style="font-size:0.7rem; opacity:0.8">(Local / Drive • Max 5MB)</span></p>
                            </div>
                        </div>

                        <!-- Al-Quran Zone -->
                        <div class="card upload-card" data-subject="alquran"
                            style="border: 2px dashed #f59e0b; background: #fffbeb; text-align: center; cursor: pointer; transition: all 0.2s; position: relative;"
                            ondragenter="handleDragOver(event, this)" ondragover="handleDragOver(event, this)"
                            ondragleave="handleDragLeave(event, this)" ondrop="handleDrop(event, 'alquran')"
                            onclick="triggerFileUpload('alquran')">
                            <div style="pointer-events: none;">
                                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">📖</div>
                                <h6 style="color: #92400e; margin: 0;">AL-QURAN</h6>
                                <p style="font-size: 0.75rem; color: #78350f;">Drop PDF or Click to Browse<br><span
                                        style="font-size:0.7rem; opacity:0.8">(Local / Drive • Max 5MB)</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden Input for click-to-upload -->
                    <!-- Changed display:none to opacity:0 to ensure it works on all browsers -->
                    <input type="file" id="bulkFileInput" multiple accept="application/pdf"
                        style="position: absolute; width: 0; height: 0; opacity: 0; overflow: hidden; z-index: -1;"
                        onchange="handleSelectedFiles(this.files)">
                </div>

                <div id="uploadProgressContainer" style="margin-bottom: 2rem; display: none;">
                    <h6 style="margin-bottom: 0.5rem;">Upload Status:</h6>
                    <div id="progressList" style="max-height: 200px; overflow-y: auto;"></div>
                </div>

                <!-- Hidden manual input removed per request, but keeping Submit button container structured if needed -->
                <!-- button class="btn btn-primary" onclick="submitQuestion()">💾 Simpan Soal</button> (Use for manual only if re-added) -->

                <div style="margin-top: 2rem; border-top: 1px dashed var(--border-color); padding-top: 1rem;">
                    <h4 style="margin-bottom: 1rem;">📋 Daftar Soal Tersimpan</h4>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <select id="filterQuestionRoom" class="form-input form-select" style="width: auto;"
                            onchange="loadQuestionList()">
                            <option value="all">Semua Ruangan</option>
                        </select>
                        <select id="filterQuestionSubject" class="form-input form-select" style="width: auto;"
                            onchange="loadQuestionList()">
                            <option value="all">Semua Mapel</option>
                            <option value="english">English</option>
                            <option value="arabic">Arabic</option>
                            <option value="alquran">Al-Quran</option>
                        </select>
                    </div>
                    <!-- Fixed height container for list -->
                    <div id="questionList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- Ruangan Tab -->
            <div id="ruanganTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">🏫 Kelola Ruangan</h4>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="newClassName" class="form-input" placeholder="Nama ruangan baru..."
                        style="flex: 1;">
                    <button class="btn btn-primary" onclick="addNewClass()">+ Tambah</button>
                </div>
                <div id="classList" style="margin-top: 1rem;"></div>

                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <h4>✏️ Edit Nama Ruangan</h4>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <select id="editClassOld" class="form-input form-select" style="width: auto;"></select>
                        <span style="align-self: center;">→</span>
                        <input type="text" id="editClassNew" class="form-input" placeholder="Nama baru"
                            style="width: 150px;">
                        <button class="btn btn-secondary" onclick="editClass()">Simpan</button>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="exportTab" class="tab-content">
                <h4 style="margin-bottom: 1rem;">📦 Export & Backup</h4>

                <div class="grid grid-2" style="gap: 1.5rem;">
                    <div>
                        <h5 style="margin-bottom: 0.75rem;">📄 Download QR sebagai HTML</h5>

                        <div class="export-option" onclick="exportQR('all')">
                            <h5>📦 Semua Data</h5>
                            <p>Download QR semua siswa, guru, dan penguji</p>
                        </div>

                        <div class="export-option" onclick="exportQR('siswa')">
                            <h5>👨‍🎓 Hanya Siswa</h5>
                            <p>Download QR code semua siswa saja</p>
                        </div>

                        <div class="export-option" onclick="exportQR('panitia')">
                            <h5>👔 Hanya Panitia</h5>
                            <p>Download QR code semua panitia saja</p>
                        </div>

                        <div class="export-option" onclick="exportQR('penguji')">
                            <h5>📋 Hanya Penguji</h5>
                            <p>Download QR code semua penguji saja</p>
                        </div>

                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <h5 style="margin-bottom: 0.75rem;">🖨️ Print QR Cards</h5>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                                <select id="printPaperSize" class="form-input form-select" style="width: auto;">
                                    <option value="A4">A4 (210×297mm)</option>
                                    <option value="A3">A3 (297×420mm)</option>
                                </select>
                                <select id="printCardCount" class="form-input form-select" style="width: auto;">
                                    <option value="4">4 kartu/halaman (2×2)</option>
                                    <option value="6">6 kartu/halaman (2×3)</option>
                                    <option value="8">8 kartu/halaman (2×4)</option>
                                    <option value="9">9 kartu/halaman (3×3)</option>
                                </select>
                            </div>
                            <div class="export-option" onclick="togglePrintSettings()">
                                <h5>🖨️ Cetak QR Cards</h5>
                                <p>Cetak kartu QR sesuai pengaturan</p>
                            </div>

                            <div id="printSettings"
                                style="display: none; background: var(--bg-surface); padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-top: 0.5rem;">
                                <h6 style="margin-bottom: 0.5rem;">Pengaturan Batch</h6>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 0.8rem;">Mulai dari</label>
                                        <input type="number" id="printStart" class="form-input" value="1" min="1">
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-size: 0.8rem;">Jumlah</label>
                                        <input type="number" id="printLimit" class="form-input" value="50" min="1">
                                    </div>
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <label class="form-control">
                                        <input type="checkbox" id="printHighQuality" checked>
                                        High Quality (HD)
                                    </label>
                                </div>
                                <button class="btn btn-primary btn-sm" style="width: 100%;" onclick="printQRCards()">🖨️
                                    Generate & Print</button>
                                <div id="printProgress"
                                    style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); display: none;">
                                    Siap...</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div
                            style="background: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                            <h5 style="margin-bottom: 1rem; color: var(--text-primary);">🛠️ Data Center</h5>

                            <!-- Row 1: Quick Actions -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 1rem;">
                                <div class="export-option" onclick="exportToCSV()"
                                    style="margin: 0; padding: 10px; text-align: center;">
                                    <h6 style="margin: 0; font-size: 0.9rem;">📊 Full CSV</h6>
                                    <small style="font-size: 0.75rem;">All Backup</small>
                                </div>
                                <div class="export-option" onclick="createBackup()"
                                    style="margin: 0; padding: 10px; text-align: center;">
                                    <h6 style="margin: 0; font-size: 0.9rem;">💾 Backup JSON</h6>
                                    <small style="font-size: 0.75rem;">Save Data</small>
                                </div>
                            </div>

                            <!-- Row 2: Canva Export -->
                            <div
                                style="background: #fdf4ff; border: 1px solid #e879f9; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                                <h6 style="margin: 0 0 8px 0; color: #9333ea; font-size: 0.9rem;">🎨 Canva Export (Bulk)
                                </h6>
                                <div style="display: flex; gap: 15px; margin-bottom: 8px; flex-wrap: wrap;">
                                    <label
                                        style="cursor: pointer; font-size: 0.8rem; display: flex; align-items: center;"><input
                                            type="checkbox" id="checkStudent" checked style="margin-right:4px;">
                                        Student</label>
                                    <label
                                        style="cursor: pointer; font-size: 0.8rem; display: flex; align-items: center;"><input
                                            type="checkbox" id="checkExaminer" checked style="margin-right:4px;">
                                        Examiner</label>
                                    <label
                                        style="cursor: pointer; font-size: 0.8rem; display: flex; align-items: center;"><input
                                            type="checkbox" id="checkCommittee" checked style="margin-right:4px;">
                                        Committee</label>
                                </div>
                                <button class="btn btn-sm" style="width: 100%; background: #9333ea; color: white;"
                                    onclick="exportCanvaCSV()">⬇️ Download CSV</button>
                            </div>

                            <!-- Row 3: HTML QR Export -->
                            <div style="margin-bottom: 10px;">
                                <h6 style="margin-bottom: 5px; font-size: 0.9rem;">📄 Export QR (HTML)</h6>
                                <div style="display: flex; gap: 5px;">
                                    <select id="exportHtmlCategory" class="form-input"
                                        style="padding: 6px; font-size: 0.85rem;">
                                        <option value="all">Semua Data</option>
                                        <option value="siswa">Hanya Siswa</option>
                                        <option value="panitia">Hanya Panitia</option>
                                        <option value="penguji">Hanya Penguji</option>
                                    </select>
                                    <button class="btn btn-primary btn-sm"
                                        onclick="exportQR(document.getElementById('exportHtmlCategory').value)">Go</button>
                                </div>
                            </div>

                            <!-- Restore Link -->
                            <div style="text-align: center; margin-top: 10px;">
                                <small style="cursor: pointer; text-decoration: underline; color: var(--primary);"
                                    onclick="document.getElementById('restoreFile').click()">📥 Restore from Backup
                                    File</small>
                            </div>
                        </div>
                        <p>Pulihkan data dari file backup</p>
                    </div>
                    <input type="file" id="restoreFile" accept=".json" style="display: none;"
                        onchange="handleRestore(event)">
                </div>

                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <h5 style="margin-bottom: 0.75rem;">🔍 Download QR Individual</h5>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="text" id="searchQR" class="form-input" placeholder="Cari nama..." style="flex: 1;">
                        <button class="btn btn-secondary" onclick="searchAndShowQR()">Cari</button>
                    </div>
                    <div id="individualQRResult" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
        </div>
        </div>
    </main>

    <div class="floating-auth">
        <button class="btn btn-secondary" onclick="toggleAuth()" id="floatingBtn">🔐 Login</button>
    </div>

    <script src="js/storage.js?v=2.6"></script>
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Check auth
            const session = getSession();
            if (!session || (session.role !== 'panitia_utama' && session.role !== 'panitia' && session.role !== 'guru')) {
                window.location.href = 'index.html';
            }

            // Role-based UI restriction
            if (session.role !== 'panitia_utama') {
                // Hide restricted tabs for regular Panitia
                if (document.getElementById('btnTabPanitia')) document.getElementById('btnTabPanitia').style.display = 'none';
                if (document.getElementById('btnTabPenguji')) document.getElementById('btnTabPenguji').style.display = 'none';
            }

            // Show content and update button
            document.getElementById('mainContent').style.display = 'block';
            if (document.getElementById('floatingBtn')) document.getElementById('floatingBtn').innerHTML = '🚪 Logout';

            // Initial load
            updateStats();
            loadStudentList();
            if (session.role === 'panitia_utama') {
                loadPanitiaList(); // Only load if visible
                loadExaminerList();
            }

            // Initialize Sync
            if (window.firebaseService) {
                window.firebaseService.initSync();
            }

            // Listen for sync updates
            window.addEventListener('storage-update', () => {
                console.log('🔄 Data synced, refreshing UI...');
                updateStats();
                loadStudentList();
                loadExaminerList();
            });

            // Listen for student-specific updates
            window.addEventListener('students-updated', () => {
                console.log('UI: Student list updated from sync');
                loadStudentList();
                updateStats();
            });

            if (typeof loadClassList === 'function') loadClassList();

            // Initialize room dropdowns for questions
            loadQuestionRooms();

            document.getElementById('searchStudent').addEventListener('input', loadStudentList);
            document.getElementById('filterType').addEventListener('change', loadStudentList);
        });

        // ==========================================
        // QUESTION MANAGEMENT (SOAL UJIAN)
        // ==========================================

        function loadQuestionRooms() {
            const classes = getClasses();
            const qRoom = document.getElementById('questionRoom');
            const fRoom = document.getElementById('filterQuestionRoom');

            if (qRoom) {
                const current = qRoom.value;
                qRoom.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`).join('');
                if (current && classes.includes(current)) qRoom.value = current;
                else if (classes.length > 0) qRoom.value = classes[0];
            }
            if (fRoom) {
                const current = fRoom.value;
                fRoom.innerHTML = '<option value="all">Semua Ruangan</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
                fRoom.value = current;
            }
        }

        function submitQuestion() {
            const subject = document.getElementById('questionSubject').value;
            const room = document.getElementById('questionRoom').value;
            // Removed manual content input
            alert('Silakan gunakan Bulk Upload PDF untuk menambahkan soal.');
        }

        async function removeQuestion(id) {
            if (!confirm('Hapus soal ini? File di cloud juga akan dihapus.')) return;

            const question = getQuestions().find(q => q.id === id);

            // Delete file if exists
            if (question && question.storagePath && window.firebaseService) {
                try {
                    // Show some loading indicator or just wait
                    await window.firebaseService.deleteFile(question.storagePath);
                    console.log('File deleted from storage:', question.storagePath);
                } catch (e) {
                    console.warn("File deletion failed or file not found:", e);
                    // Continue to delete record anyway
                }
            }

            deleteQuestion(id); // Using storage.js function
            loadQuestionList();
        }

        function loadQuestionList() {
            const fRoom = document.getElementById('filterQuestionRoom').value;
            const fSubject = document.getElementById('filterQuestionSubject').value;

            let questions = getQuestions();

            if (fRoom !== 'all') questions = questions.filter(q => q.room === fRoom);
            if (fSubject !== 'all') questions = questions.filter(q => q.subject === fSubject);

            const container = document.getElementById('questionList');

            if (!questions.length) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Belum ada soal tersimpan</p>';
                return;
            }
            container.innerHTML = 'Wait...'; // placeholder

            // Group by room then subject
            const grouped = {};
            questions.forEach(q => {
                const key = `${q.room} - ${q.subject.toUpperCase()}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(q);
            });

            let html = '';
            for (const [group, items] of Object.entries(grouped)) {
                html += `
                    <div class="card" style="margin-bottom: 1rem; border-left: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <h5 style="margin: 0;">${group}</h5>
                            <span class="badge badge-info">${items.length} Soal</span>
                        </div>
                        <div style="max-height: 200px; overflow-y: auto; background: var(--bg-surface); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                            ${items.map(q => `
                                <div style="margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px dashed var(--border-color);">
                                    <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
                                        <a href="${q.content}" target="_blank" style="color: var(--primary); text-decoration: underline;">📄 Buka Link</a>
                                        ${q.targetStudent ? `<span class="badge badge-warning" style="margin-left:5px; font-size: 0.7rem;">Khusus: ${q.targetStudent}</span>` : ''}
                                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${q.content}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <button class="btn btn-sm btn-danger" onclick="removeQuestion('${q.id}')" style="font-size: 0.7rem; padding: 2px 6px;">Hapus</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function toggleAuth() {
            if (isLoggedIn()) { logout(); window.location.href = 'index.html'; }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active',
                    (tab === 'siswa' && i === 0) ||
                    (tab === 'panitia' && i === 1) ||
                    (tab === 'penguji' && i === 2) ||
                    (tab === 'soal' && i === 3) ||
                    (tab === 'ruangan' && i === 4) ||
                    (tab === 'export' && i === 5)
                );
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');

            if (tab === 'soal') {
                loadQuestionRooms();
                loadQuestionList();
            }
        }

        function updateStats() {
            const students = getStudents();
            const examiners = getExaminers();
            const panitia = getPanitia();
            document.getElementById('statTotal').textContent = students.length;
            document.getElementById('statSiswa').textContent = students.filter(s => s.type === 'siswa').length;
            document.getElementById('statPanitia').textContent = panitia.length;
            document.getElementById('statPenguji').textContent = examiners.length;
        }

        function importStudents() {
            const input = document.getElementById('bulkStudents').value.trim();
            if (!input) return alert('Masukkan data!');

            const lines = input.split('\n').filter(l => l.trim());
            const studentsToAdd = [];

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts[0]) {
                    studentsToAdd.push({
                        name: parts[0],
                        class: parts[1] || '-',
                        type: 'siswa'
                    });
                }
            });

            if (studentsToAdd.length > 0) {
                addStudentsBulk(studentsToAdd);
            }

            document.getElementById('bulkStudents').value = '';
            showResult('studentImportResult', `✅ ${studentsToAdd.length} siswa berhasil diimport!`);
            updateStats();
            loadStudentList();
        }

        // Student Deletion Logic
        function toggleSelectAll(source) {
            document.querySelectorAll('.student-checkbox').forEach(cb => {
                cb.checked = source.checked;
            });
        }

        function deleteSelectedStudents() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            if (checkboxes.length === 0) return alert('Pilih siswa yang akan dihapus!');

            if (confirm(`Hapus ${checkboxes.length} siswa terpilih?`)) {
                const ids = Array.from(checkboxes).map(cb => cb.value);

                // Optimized deletion: read, filter, save once implies we need a bulk delete in storage.js or just loop
                // Looping deleteStudent reads/writes every time.
                // Let's implement manual bulk delete here for performance
                let students = getStudents();
                const initialCount = students.length;
                students = students.filter(s => !ids.includes(s.id));

                if (students.length !== initialCount) {
                    saveStudents(students);
                    showResult('studentImportResult', `✅ ${ids.length} siswa dihapus.`);
                    loadStudentList();
                    updateStats();
                }
            }
        }

        function clearAllStudents() {
            // ... (keep existing)
            if (confirm('⚠️ PERINGATAN: Hapus SEMUA siswa?')) {
                saveStudents([]);
                updateStats();
                loadStudentList();
            }
        }

        function importPanitia() {
            const input = document.getElementById('bulkPanitia').value.trim();
            if (!input) return alert('Masukkan data!');

            const lines = input.split('\n').filter(l => l.trim());
            const usersToAdd = [];
            const errors = [];

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 3) {
                    usersToAdd.push({
                        username: parts[0],
                        password: parts[1],
                        name: parts[2],
                        role: 'panitia',
                        subject: parts[3] || 'Panitia',
                        assignedClasses: []
                    });
                } else if (parts[0]) {
                    errors.push(`${parts[0]}: Format salah (Butuh: Username, Password, Nama)`);
                }
            });

            if (usersToAdd.length > 0) {
                const result = addUsersBulk(usersToAdd);
                if (result.errors) errors.push(...result.errors);
            }

            document.getElementById('bulkPanitia').value = '';
            let msg = `✅ ${usersToAdd.length - (errors.length ? 0 : 0)} panitia berhasil diproses!`;
            // Correct count logic: usersToAdd includes those that might have failed in bulk (duplicate username)
            // addUsersBulk returns { added, errors }
            // So we should capture the result properly.

            // Let's refine the logic inside the replacement content:
            /*
            const result = addUsersBulk(usersToAdd);
            const successCount = result.added.length;
            errors.push(...result.errors);
            */
            // See revised content below.
        }

        function clearAllPanitia() {
            if (confirm('⚠️ PERINGATAN: Apakah Anda yakin ingin menghapus SEMUA panitia?\n\nIni akan menghapus:\n1. Panitia dengan login (Baru)\n2. Panitia tanpa login (Lama)\n\nData tidak dapat dikembalikan!')) {
                // 1. Delete from Users (New System)
                const allUsers = getUsers();
                const panitiaUsers = allUsers.filter(u => u.role === 'panitia' && u.id !== 'admin-001');
                panitiaUsers.forEach(u => deleteUser(u.id));

                // 2. Delete from Students (Legacy System)
                const students = getStudents();
                const initialCount = students.length;
                const newStudents = students.filter(s => s.type !== 'panitia' && s.type !== 'guru');

                if (students.length !== newStudents.length) {
                    saveStudents(newStudents);
                }

                updateStats();
                loadPanitiaList();
                alert('✅ Data panitia berhasil dibersihkan.');
            }
        }

        function importExaminers() {
            const input = document.getElementById('bulkExaminers').value.trim();
            if (!input) return alert('Masukkan data!');

            const lines = input.split('\n').filter(l => l.trim());
            const usersToAdd = [];
            const errors = [];

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 4) {
                    usersToAdd.push({
                        username: parts[0],
                        password: parts[1],
                        name: parts[2],
                        role: 'penguji',
                        subject: parts[3].toLowerCase(),
                        assignedClasses: parts[4] ? parts[4].split('|').map(c => c.trim()) : []
                    });
                } else if (parts[0]) {
                    errors.push(`${parts[0]}: Format salah`);
                }
            });

            let successCount = 0;
            if (usersToAdd.length > 0) {
                const result = addUsersBulk(usersToAdd);
                successCount = result.added.length;
                if (result.errors) errors.push(...result.errors);
            }

            document.getElementById('bulkExaminers').value = '';
            let msg = `✅ ${successCount} penguji berhasil ditambahkan!`;
            if (errors.length) msg += `<br>⚠️ ${errors.join(', ')}`;
            showResult('examinerImportResult', msg);
            updateStats();
            loadExaminerList();
        }

        function showResult(id, msg) {
            const el = document.getElementById(id);
            el.innerHTML = msg;
            el.style.display = 'flex';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function loadStudentList() {
            let students = getStudents().filter(s => s.type === 'siswa');
            const search = document.getElementById('searchStudent').value.toLowerCase();

            if (search) students = students.filter(s => s.name.toLowerCase().includes(search) || s.class.toLowerCase().includes(search));

            document.getElementById('studentCount').textContent = students.length;
            const container = document.getElementById('studentList');

            if (!students.length) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Tidak ada data siswa</p>';
                return;
            }

            container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead><tr><th style="width:40px"><input type="checkbox" id="selectAllStudents" onchange="toggleSelectAll(this)"></th><th>No</th><th>Nama</th><th>Ruangan</th><th>Jenis</th><th>Aksi</th></tr></thead>
            <tbody>
              ${students.slice(0, 50).map((s, i) => `
                <tr>
                  <td><input type="checkbox" class="student-checkbox" value="${s.id}"></td>
                  <td>${i + 1}</td>
                  <td>${s.name}</td>
                  <td>${s.class}</td>
                  <td><span class="badge badge-success">Siswa</span></td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="downloadSingleQR('${s.id}', 'student')">📱</button>
                    <button class="btn btn-sm btn-danger" onclick="delStudent('${s.id}')">🗑️</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          ${students.length > 50 ? `<p style="text-align:center; color:var(--text-muted); padding:0.5rem;">...dan ${students.length - 50} siswa lainnya</p>` : ''}
        </div>
      `;
        }

        function loadPanitiaList() {
            // Get Panitia from Users (New) and Legacy Panitia (if any)
            const allUsers = getUsers();
            const panitiaUsers = allUsers.filter(u => u.role === 'panitia');

            const search = document.getElementById('searchPanitia').value.toLowerCase();
            let displayList = panitiaUsers;

            if (search) displayList = displayList.filter(s => s.name.toLowerCase().includes(search));
            document.getElementById('panitiaCount').textContent = displayList.length;

            const container = document.getElementById('panitiaList');
            if (displayList.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:1rem; color:var(--text-muted);">Belum ada panitia</p>';
                return;
            }

            container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead><tr><th>Username</th><th>Nama</th><th>Jabatan</th><th>Aksi</th></tr></thead>
            <tbody>
              ${displayList.map(p => `
                <tr>
                  <td>${p.username}</td>
                  <td>${p.name}</td>
                  <td>${p.subject || '-'}</td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="downloadSingleQR('${p.id}', 'panitia')">📱</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${p.id}'); loadPanitiaList(); updateStats();">🗑️</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
        }

        function loadExaminerList() {
            const examiners = getExaminers();
            document.getElementById('examinerCount').textContent = examiners.length;

            const container = document.getElementById('examinerList');
            if (!examiners.length) {
                container.innerHTML = '<p style="text-align:center; padding:1rem; color:var(--text-muted);">Belum ada penguji</p>';
                return;
            }

            container.innerHTML = `
        <div class="table-container">
          <table class="table">
            <thead><tr><th>Username</th><th>Nama</th><th>Mapel</th><th>Ruangan</th><th>Aksi</th></tr></thead>
            <tbody>
              ${examiners.map(e => `
                <tr>
                  <td>${e.username}</td>
                  <td>${e.name}</td>
                  <td>${e.subject}</td>
                  <td>${e.assignedClasses ? e.assignedClasses.map(c => `<span class="badge badge-info">${c}</span>`).join('') : '-'}</td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="downloadSingleQR('${e.id}', 'penguji')">📱</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${e.id}'); loadExaminerList(); updateStats();">🗑️</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
        }

        function delStudent(id) {
            if (confirm('Hapus siswa ini?')) {
                deleteStudent(id);
                loadStudentList();
                updateStats();
            }
        }

        // QR Printing Logic
        function togglePrintSettings() {
            const el = document.getElementById('printSettings');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function printQRCards() {
            const btn = document.querySelector('#printSettings button');
            const progressEl = document.getElementById('printProgress');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Generating...';
            btn.disabled = true;
            progressEl.style.display = 'block';
            progressEl.textContent = 'Menyiapkan data...';

            // Get Paper Size
            const paperSize = document.getElementById('printPaperSize').value; // 'A4' or 'A3'
            const cardCount = parseInt(document.getElementById('printCardCount').value); // 4, 6, 8, 9

            // Define card dimensions based on count
            // A4 is 210x297mm.
            let cardWidth, cardHeight, fontSize;
            let rows, cols;

            if (cardCount === 4) { cols = 2; rows = 2; }
            if (cardCount === 6) { cols = 2; rows = 3; }
            if (cardCount === 8) { cols = 2; rows = 4; }
            if (cardCount === 9) { cols = 3; rows = 3; }

            // CSS Grid style will handle layout
            const gridTemplate = `repeat(${cols}, 1fr)`;

            try {
                const students = getStudents(); // Get all people (students, panitia, etc.) based on export filter
                // However, the exportQR functions are separate. This print features seems to target ALL shown in stats?
                // Let's assume it prints whatever is in `students` array which includes everyone if `getStudents` returns all types?
                // Actually `getStudents` returns mixed types now.
                // Let's filter based on what user might expect. Usually students.
                // But for now, let's just print ALL valid logical users (Student, Panitia, Penguji)
                // Or maybe just Students?
                // Let's print Students only by default for "Kartu Ujian" context
                const studentsOnly = getStudents().filter(s => s.type === 'siswa');

                const start = parseInt(document.getElementById('printStart').value) - 1;
                const limit = parseInt(document.getElementById('printLimit').value);
                const targetStudents = studentsOnly.slice(start, start + limit);

                if (targetStudents.length === 0) throw new Error('Tidak ada data siswa untuk dicetak pada range ini.');

                progressEl.textContent = `Generating QR for ${targetStudents.length} cards...`;

                // Prepare QR data
                const studentQRs = [];
                for (const s of targetStudents) {
                    const qrCode = new QRCodeStyling({
                        width: 1000, height: 1000, // High res for print
                        data: s.qrCode || s.id,
                        image: "img/logo-alwildan.png",
                        dotsOptions: { color: "#000", type: "rounded" },
                        backgroundOptions: { color: "#fff" },
                        imageOptions: { crossOrigin: "anonymous", margin: 10 }
                    });
                    const blob = await qrCode.getRawData("png");
                    const url = URL.createObjectURL(blob);
                    studentQRs.push({ ...s, qrUrl: url });
                }

                // Create Print Window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
    <html>
    <head>
        <title>Print QR Cards</title>
        <style>
            @page {
                size: ${paperSize};
                margin: 10mm;
            }
            body { 
                font-family: 'Inter', sans-serif; 
                margin: 0; 
                padding: 0;
                background: white;
            }
            .page {
                width: 100%;
                height: 98vh; /* Approximate full page height */
                display: grid;
                grid-template-columns: ${gridTemplate};
                grid-template-rows: repeat(${rows}, 1fr);
                gap: 10mm;
                page-break-after: always;
            }
            .page:last-child { page-break-after: auto; }
            .card {
                border: 2px solid #000;
                border-radius: 10px;
                padding: 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                box-sizing: border-box;
                height: 100%;
            }
            .card h3 { margin: 5px 0; font-size: 16pt; font-weight: 800; text-transform: uppercase; }
            .card p { margin: 5px 0; font-size: 12pt; }
            .card img { width: 60%; height: auto; margin: 10px 0; }
            .type { 
                background: #000; color: #fff; padding: 2px 8px; border-radius: 4px; 
                font-size: 10pt; text-transform: uppercase; margin-left: 5px;
            }
            .code {
                font-family: monospace;
                font-size: 12pt;
                font-weight: 800;
                color: #000;
                letter-spacing: 4px;
            }

            @media print {
                @page { size: ${paperSize}; margin: 0; }
                body { margin: 0; }
            }
        </style>
    </head>
    <body>
        ${(() => {
                        let html = '';
                        for (let i = 0; i < studentQRs.length; i += cardCount) {
                            const pageItems = studentQRs.slice(i, i + cardCount);
                            html += '<div class="page">';
                            pageItems.forEach(s => {
                                const code = (s.qrCode || s.id).split('').join(' ');
                                html += '<div class="card">' +
                                    '<h3>' + s.name + '</h3>' +
                                    '<img src="' + s.qrUrl + '" alt="QR">' +
                                    '<div class="code">' + code + '</div>' +
                                    '<p>' + s.class + '<span class="type">' + (s.type || 'siswa') + '</span></p>' +
                                    '</div>';
                            });
                            html += '</div>';
                        }
                        return html;
                    })()}
    </body >
    </html >
    `);
                printWindow.document.close();

                // Allow images to load
                printWindow.onload = function () {
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                        // printWindow.close(); // Optional: close after print
                    }, 1000);
                };

            } catch (e) {
                console.error(e);
                alert('Gagal generate QR: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                progressEl.textContent = 'Selesai!';
                setTimeout(() => progressEl.style.display = 'none', 3000);
            }
        }
    </script>
    <!-- Footer Credit -->


    <footer style="text-align: center; margin-top: 2rem; color: var(--text-muted); font-size: 0.8rem;">
        <p>&copy; 2026 EXOT System. Created by Muhammad Atiq Qoidul Islam</p>
        <p>Version 2.4 (Local SDK)</p>
    </footer>

    <!-- Bulk Upload Logic (Firebase Dependent) -->
    <script>
        async function uploadPDFToFirebase(file, path, onProgress) {
            return new Promise((resolve, reject) => {
                if (!window.firebaseService) {
                    reject(new Error("Firebase Service not loaded"));
                    return;
                }

                console.log(`Starting upload: ${path}`);
                const task = window.firebaseService.uploadFile(path, file);

                task.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log(`Upload: ${Math.round(progress)}% (${snapshot.bytesTransferred}/${snapshot.totalBytes})`);

                        // Update diagnostic status if available
                        const statusDiv = document.getElementById('sys-status');
                        if (statusDiv) {
                            let progEl = document.getElementById('stat-prog');
                            if (!progEl) {
                                progEl = document.createElement('span');
                                progEl.id = 'stat-prog';
                                statusDiv.appendChild(progEl);
                            }
                            progEl.innerText = `📦 ${Math.round(snapshot.bytesTransferred / 1024)}KB / ${Math.round(snapshot.totalBytes / 1024)}KB`;
                            progEl.style.color = '#4caf50';
                        }

                        if (onProgress) onProgress(progress);
                    },
                    (error) => {
                        console.error("Firebase Upload Error:", error);
                        // Visualize specific error codes
                        let msg = error.message;
                        if (error.code === 'storage/unauthorized') {
                            msg = 'Izin Ditolak (CORS/Auth). Cek Console & CORS Config.';
                        } else if (error.code === 'storage/canceled') {
                            msg = 'Upload dibatalkan.';
                        } else if (error.code === 'storage/unknown') {
                            msg = 'Error tidak diketahui, cek koneksi.';
                        }
                        reject(new Error(msg));
                    },
                    async () => {
                        try {
                            const downloadURL = await task.snapshot.ref.getDownloadURL();
                            resolve(downloadURL);
                        } catch (e) {
                            console.error("Get Download URL Error:", e);
                            reject(e);
                        }
                    }
                );
            });
        }

        async function processFiles(files, subject) {
            const progressContainer = document.getElementById('uploadProgressContainer');
            const progressList = document.getElementById('progressList');
            progressContainer.style.display = 'block';
            progressList.innerHTML = ''; // Clear previous

            for (const file of files) {
                if (file.type !== 'application/pdf') {
                    addProgressItem(file.name, '❌ Bukan file PDF', 'error');
                    continue;
                }

                // Limit File Size to 5MB
                const MAX_SIZE_MB = 5;
                if (file.size > MAX_SIZE_MB * 1024 * 1024) {
                    addProgressItem(file.name, `❌ File terlalu besar (> ${MAX_SIZE_MB}MB)`, 'error');
                    alert(`File ${file.name} terlalu besar! Maksimal ${MAX_SIZE_MB}MB.`);
                    continue;
                }

                // Create Progress Item
                const progressItem = addProgressItem(file.name, '⏳ Memulai upload...', 'pending');

                // Parse Filename: ROOM-NAME.pdf (Subject is passed implicitly)
                const filename = file.name.replace('.pdf', '');
                const parts = filename.split('-');

                let room, name;

                // Heuristic: If 3 parts, assume SUBJECT-ROOM-NAME. If 2, ROOM-NAME.
                if (parts.length >= 3) {
                    // Legacy: ENGLISH-7A-AHMAD -> Ignore index 0
                    room = parts[1].trim();
                    name = parts.slice(2).join('-').trim(); // Join rest as name
                } else if (parts.length === 2) {
                    // New: 7A-AHMAD
                    room = parts[0].trim();
                    name = parts[1].trim();
                } else {
                    updateProgressItem(progressItem, '❌ Format nama file salah. Gunakan: RUANGAN-NAMA.pdf', 'error');
                    continue;
                }

                // Find Student ID
                const students = getStudents();
                const student = students.find(s =>
                    s.name.toLowerCase() === name.toLowerCase() &&
                    s.class.toLowerCase() === room.toLowerCase()
                );

                if (!student) {
                    updateProgressItem(progressItem, `❌ Siswa tidak ditemukan: ${name} di ${room}`, 'error');
                    continue;
                }

                // Upload to Firebase
                try {
                    const authText = window.currentUser ? `(User: ${window.currentUser.uid.substring(0, 4)}..)` : '(No Auth!)';
                    updateProgressItem(progressItem, `🚀 Mengupload... ${authText}`, 'loading');

                    // Allow retry if auth is missing, but don't block more than 5 seconds
                    if (!window.currentUser && window.auth) {
                        try {
                            // Race condition: Auth vs 5s Timeout
                            const authPromise = window.auth.signInAnonymously();
                            const timeoutPromise = new Promise((_, reject) =>
                                setTimeout(() => reject(new Error("Auth Timeout")), 5000)
                            );

                            await Promise.race([authPromise, timeoutPromise]);
                            console.log("✅ Auto-signin success");
                        } catch (authErr) {
                            console.warn("⚠️ Auto-signin failed/timed-out, trying upload anyway:", authErr);
                        }
                    }

                    // Path: questions/SUBJECT/ROOM/FILENAME
                    const path = `questions/${subject}/${room}/${file.name}`;

                    const downloadURL = await uploadPDFToFirebase(file, path, (progress) => {
                        updateProgressItem(progressItem, `🚀 Uploading... ${Math.round(progress)}%`, 'loading');
                        // Update bar width manually if needed or via helper
                        const el = document.getElementById(progressItem);
                        const bar = el?.querySelector('.progress-bar');
                        if (bar) {
                            bar.style.width = `${progress}%`;
                            bar.style.transition = 'width 0.1s linear';
                        }
                    });

                    // Add to Database (Storage.js)
                    // Signature: addQuestion(room, subject, content, type, targetStudent, storagePath)
                    addQuestion(room, subject, downloadURL, 'pdf', student.name, path);

                    updateProgressItem(progressItem, `✅ Berhasil! Disimpan untuk ${name}`, 'success');

                } catch (err) {
                    console.error(err);
                    let msg = `❌ Gagal upload: ${err.message}`;
                    if (err.message.includes('timed out')) {
                        msg = '❌ Koneksi lambat/terputus. Coba lagi.';
                    }
                    updateProgressItem(progressItem, msg, 'error');
                    alert(msg + "\n\nPastikan internet lancar dan file tidak corrupt.");
                }
            }

            loadQuestionList(); // Refresh list
        }

        function addProgressItem(filename, status, type) {
            const list = document.getElementById('progressList');
            const id = 'prog-' + Math.random().toString(36).substr(2, 9);

            let icon = '📄';
            let color = 'var(--text-primary)';
            let bg = 'var(--bg-surface)';

            if (type === 'error') { color = 'var(--danger)'; bg = '#fee2e2'; icon = '❌'; }
            if (type === 'success') { color = 'var(--success)'; bg = '#dcfce7'; icon = '✅'; }
            if (type === 'loading') { color = 'var(--info)'; bg = '#e0f2fe'; icon = '⏳'; }

            const html = `
                <div id="${id}" style="
                    display: flex; align-items: center; justify-content: space-between;
                    padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 6px;
                    background: ${bg}; border: 1px solid var(--border-color); font-size: 0.85rem;
                ">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>${icon}</span>
                        <strong>${filename}</strong>
                    </div>
                    <span class="status-text" style="color: ${color}; font-weight: 500;">${status}</span>
                </div>
            `;
            list.insertAdjacentHTML('afterbegin', html);
            return id;
        }

        function updateProgressItem(id, status, type) {
            const el = document.getElementById(id);
            if (!el) return;

            let color = 'var(--text-primary)';
            let bg = 'var(--bg-surface)';

            if (type === 'error') { color = '#dc2626'; bg = '#fee2e2'; } // Tailwind red-600, red-100
            if (type === 'success') { color = '#16a34a'; bg = '#dcfce7'; } // Tailwind green-600, green-100
            if (type === 'loading') { color = '#0284c7'; bg = '#e0f2fe'; } // Tailwind sky-600, sky-100

            el.style.background = bg;
            el.querySelector('.status-text').textContent = status;
            el.querySelector('.status-text').style.color = color;

            // Add simple progress animation bar if loading
            if (type === 'loading') {
                if (!el.querySelector('.progress-bar')) {
                    const bar = document.createElement('div');
                    bar.className = 'progress-bar';
                    bar.style.cssText = `
                        position: absolute; bottom: 0; left: 0; height: 3px; background: ${color};
                        width: 0%; transition: width 10s linear; border-radius: 0 0 6px 6px;
                    `;
                    el.style.position = 'relative';
                    el.style.overflow = 'hidden';
                    el.appendChild(bar);
                    // Trigger animation
                    setTimeout(() => bar.style.width = '90%', 100);
                }
            } else {
                const bar = el.querySelector('.progress-bar');
                if (bar) {
                    bar.style.width = '100%';
                    setTimeout(() => bar.remove(), 500);
                }
            }
        }
    </script>

    <!-- Firebase Compat SDK (Local) -->
    <script src="js/firebase-app-compat.js"></script>
    <script src="js/firebase-firestore-compat.js"></script>
    <script src="js/firebase-storage-compat.js"></script>

    <!-- Firebase Auth (CDN - Required for Storage Rules) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <!-- App Scripts (Compat Mode) -->
    <script src="js/firebase-config.js?v=2.5"></script>
    <script src="js/firebase-service.js?v=2.5"></script>
    <script>
        // Auto Sign-in Anonymously for Storage Access
        document.addEventListener('DOMContentLoaded', () => {
            if (window.auth) {
                window.auth.signInAnonymously()
                    .then(() => console.log("✅ Signed in anonymously"))
                    .catch(error => console.error("❌ Auth Error:", error));
            } else {
                console.warn("⚠️ Auth not loaded - Uploads may fail");
            }
        });
    </script>
</body>

</html>